<!--
 * @Author: Clover 304363641@qq.com
 * @Date: 2022-07-21 11:53:13
 * @LastEditors: Clover 304363641@qq.com
 * @LastEditTime: 2022-09-08 11:39:52
 * @FilePath: \storyline-generator\views\index.html
 * @Description: 
 * 
 * Copyright (c) 2022 by Clover 304363641@qq.com, All Rights Reserved. 
-->
<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>$N Recognizer</title>
	<!--[if IE]><script src="excanvas.js"></script><![endif]-->
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
	<!-- 新 Bootstrap5 核心 CSS 文件 -->
	<link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/5.1.1/css/bootstrap.min.css">
	<!--  popper.min.js 用于弹窗、提示、下拉菜单 -->
	<script src="https://cdn.staticfile.org/popper.js/2.9.3/umd/popper.min.js"></script>
	<!-- 最新的 Bootstrap5 核心 JavaScript 文件 -->
	<script src="https://cdn.staticfile.org/twitter-bootstrap/5.1.1/js/bootstrap.min.js"></script>
	<script src="https://cdn.bootcss.com/wordcloud2.js/1.1.0/wordcloud2.js"></script>
	<link href="css/styles.css" rel="stylesheet" type="text/css" />
	<script type="text/javascript" src="js/canvas.text.js"></script>
	<script type="text/javascript" src="js/faces/gentilis-normal-normal.js"></script>
	<script type="text/javascript" src="js/jquery-1.7.2.min.js"></script>
	<script type="text/javascript" src="js/d3.js"></script>
    <script src="./js/d3.layout.cloud.js"></script>
	<script src="./js/echart.js"></script>
    <script src="./js/echarts-wordcloud.js"></script>
	<script type="text/javascript" src="js/ndollar.js"></script>
	<script type="text/javascript" src="js/storyline.js"></script>
	<script type="text/javascript" src="js/database.js"></script>
	<script type="text/javascript" src="js/session.js"></script>
	<script type="text/javascript" src="js/utils.js"></script>
	<script type="text/javascript" src="js/panel.js"></script>



	<script type="text/javascript">
		//
		// Startup
		//
		var _isDown, _points, _strokes, _r, _g, _rc,_isStart,sessionList; // global variables
		var session = new Session()
		var curSessionID =''
		var page=0;
		var totalPageNum = 0;
		//i1,i2...
		var eventCounter = 0;
		var textArray = []
	    var pattern = new RegExp("[A-Za-z]+");
		//var patterncontent= new RegExp("[/\\x{7b2c}+/w+\\x{56de}/u]")
		// var patterncontent=  /第[0-9][0-9]回/
		var patterncontent=  /Chapter/

		var menuArray = []

		document.ontouchstart = null;
		document.ontouchmove = null;
		document.ontouchend = null;

		function onLoadEvent()
		{
			_points = new Array(); // point array for current stroke
			_strokes = new Array(); // array of point arrays
			_text = new Array();//array of regonize text
			_textValue = ''
			_r = new NDollarRecognizer(false);

			var canvas = document.getElementById('myCanvas');
			_g = canvas.getContext('2d');
			_g.lineWidth = 2;
			_g.font = "16px Gentilis";
			_rc = getCanvasRect(canvas); // canvas rect on page
			// _g.fillStyle = "rgb(255,255,136)";
			// _g.fillRect(0, 0, _rc.width, 20);

			_isDown = false;
			_isStart = false
			sessionList = new Array()
			session = new Session()
		}
		function getCanvasRect(canvas)
		{
			var w = canvas.width;
			var h = canvas.height;

			var cx = canvas.offsetLeft;
			var cy = canvas.offsetTop;
			while (canvas.offsetParent != null)
			{
				canvas = canvas.offsetParent;
				cx += canvas.offsetLeft;
				cy += canvas.offsetTop;
			}
			return {x: cx, y: cy, width: w, height: h};
		}
		function getScrollX()
		{
			var scrollX = $(window).scrollLeft();
			return scrollX;
		}
		function getScrollY()
		{
			var scrollY = $(window).scrollTop();
			return scrollY;
		}
		function getDomElements(x,y){
			var left = $("#text").offset().left
			var top = $("#text").offset().top
			return document.elementsFromPoint(x+left,y+top)
		}
		//
		// Mouse Events
		//
		function mouseDownEvent(x, y, button)
		{
			document.onselectstart = function() { return false; } // disable drag-select
			document.onmousedown = function() { return false; } // disable drag-select
			if (button <= 1)
			{
			console.log(getScrollX(),getScrollY());

				_isDown = true;
				x -= _rc.x - getScrollX();
				y -= _rc.y - getScrollY();
				if (_points.length == 0)
				{
					_strokes.length = 0;
					// _g.clearRect(0, 0, _rc.width, _rc.height);
				}
				_points.length = 1; // clear
				_points[0] = new Point(x, y);
				// drawText("Recording stroke #" + (_strokes.length + 1) + "...");
				var clr = "rgb(" + rand(0,0) + "," + rand(0,0) + "," + rand(0,0) + ")";
				_g.strokeStyle = clr;
				_g.fillStyle = clr;
				// _g.fillRect(x - 4, y - 3, 3, 3);
			}
			else if (button == 2)
			{
				// drawText("Recognizing gesture...");
			}
		}
		function mouseMoveEvent(x, y, button)
		{
			if (_isDown)
			{
				x -= _rc.x - getScrollX();
				y -= _rc.y - getScrollY();
				_points[_points.length] = new Point(x, y); // append
				drawConnectedPoint(_points.length - 2, _points.length - 1);
			}
		}
		function mouseUpEvent(x, y, button)
		{
			document.onselectstart = function() { return true; } // enable drag-select
			document.onmousedown = function() { return true; } // enable drag-select
			if (button <= 1)
			{
				if (_isDown)
				{
					_isDown = false;
					_strokes[_strokes.length] = _points.slice(); // add new copy to set
					// drawText("Stroke #" + _strokes.length + " recorded.");
				}
				setTimeout(()=>{
					if(_isDown){
						console.log('isDown');
					}else{
						if (_strokes.length > 1 || (_strokes.length == 1 && _strokes[0].length >= 10))
						{
							var text = new Array();
							var result = _r.Recognize(
								_strokes,
								false,
								true,
								false
								);
							// drawText("Result: " + result.Name + " (" + round(result.Score,2) + ") in " + result.Time + " ms.");
							console.log(result);
							switch (result.Name) {
								case 'line/person':
									var textDoms = [{id:''}]
									var _text = []
									for(let item of _strokes[0]){
										const el = getDomElements(item.X,item.Y-10)
										if(el[1].innerText && el[1].innerText.length===1 ){
											if(el[1].id !== textDoms[textDoms.length-1].id){
													textDoms[textDoms.length] = el[1]
											}
										}
									}
									textDoms.shift()
									textDoms.forEach(dom => {
										_text[_text.length] = dom.innerText
										dom.classList.add('text-bg')
									});
									_textValue = _text.join('')									

									//弹出面板
									const floatPanelChosen = document.getElementById('float-panel-chosen')
									const chosenText = document.getElementById('chosen-text')	
									var top = _strokes[0][_strokes[0].length-1].Y					
									var left = _strokes[0][_strokes[0].length-1].X
									var leftOffset = $("#text").offset().left+10
									var topOffset = $("#text").offset().top+10
									floatPanelChosen.style.display = 'block'
									floatPanelChosen.style.top = top+topOffset+'px'
									if(left+leftOffset+250 > document.body.clientWidth){
										floatPanelChosen.style.left = ''
										floatPanelChosen.style.right = '10px'
									}else{
										floatPanelChosen.style.right = ''
										floatPanelChosen.style.left = left+leftOffset+'px'
									}
									chosenText.value = _textValue
									break;
								case 'circle/time':
									var textDoms = [{id:''}]
									var _text = []
									var time = new Object()
									var max_x=-Infinity,max_y=-Infinity;
									var min_x=Infinity,min_y=Infinity;
									for (const item of _strokes[0]) {
										if(item.X>max_x) max_x = item.X
										if(item.Y>max_y) max_y = item.Y
										if(item.X<min_x) min_x = item.X
										if(item.Y<min_y) min_y = item.Y
									}
									console.log(min_x,max_x);
									console.log(min_y,max_y);
									for (let x = min_x; x < max_x; x++) {
										for (let y = min_y; y < max_y; y++) {
											const el = getDomElements(x,y)
											if(el[1].innerText && el[1].innerText.length===1){
												if(el[1].id !== textDoms[textDoms.length-1].id){
													textDoms[textDoms.length] = el[1]
												}
											}
										}
									}
									textDoms.shift()
									textDoms.shift()
									textDoms.pop()
									textDoms.forEach(dom => {
										_text[_text.length] = dom.innerText
									});
									_text= _text.join('')
									document.getElementById('time').innerText = _text
									time.value = _text
									time.stroke = {
										pageNum:page,
										points:_strokes[0]
									}
									session.time = time
									break;		
								case 'wave/content':
									var textDoms = [{id:''}]
									var _text = []
									var event = new Object()
									for(let item of _strokes[0]){
										const el_half = getDomElements(item.X,item.Y-10)
										if(el_half[1].innerText && el_half[1].innerText.length===1 && !reg.test(el_half[1].innerText)){
											if(el_half[1].id !== textDoms[textDoms.length-1].id){
													textDoms[textDoms.length] = el_half[1]
											}
											// text[text.length] = el_half[1].innerText
										}
										const el_all = getDomElements(item.X,item.Y-20)
										if(el_all[1].innerText && el_all[1].innerText.length===1 && !reg.test(el_all[1].innerText)){
											if(el_all[1].id !== textDoms[textDoms.length-1].id){
													textDoms[textDoms.length] = el_all[1]
											}
											// text[text.length] = el_all[1].innerText
										}
									}
									textDoms.shift()
									textDoms.forEach(dom => {
										_text[_text.length] = dom.innerText
									});
									_text= _text.join('')
									document.getElementById('event').innerText = _text
									event.value = _text
									event.stroke = {
										pageNum:page,
										points:_strokes[0]
									}
									session.event = event
									break;
								case 'brkoen/place':
									var textDoms = [{id:''}]
									var _text = []
									var place = new Object()
									for(let item of _strokes[0]){
										const el = getDomElements(item.X,item.Y-10)
										if(el[1].innerText && el[1].innerText.length===1 && !reg.test(el[1].innerText)){
											if(el[1].id !== textDoms[textDoms.length-1].id){
													textDoms[textDoms.length] = el[1]
												}
										}
									}
									textDoms.shift()
									const el = document.elementsFromPoint(_strokes[0][0].X,_strokes[0][0].Y)
									if(el[1].innerText.length === 1){
										textDoms.shift()
									}
									textDoms.forEach(dom => {
										_text[_text.length] = dom.innerText
									});
									_text= _text.join('')
									document.getElementById('place').innerText = _text		
									place.value = _text
									place.stroke = {
										pageNum:page,
										points:_strokes[0]
									}	
									session.place = place														
									break;		
								case 'left/start':
									var start = new Object()
									_isStart = true
									session = new Session();
									let stroke = _strokes[0].concat(_strokes[1])
									start.stroke = {
										pageNum:page,
										points:stroke
									}	
									session.start = start	
									break;
								case 'right/end':
									_g.clearRect(0, 0, _rc.width, _rc.height);
									var end = new Object()
									end.stroke = {
										pageNum:page,
										points:_strokes[0]
									}
									session.end = end	
									session.curtime = transTimestamp()
									let output = session
									console.log(output);
									saveObjectIntoDatabase(output).then((status)=>{
										if(status === 200)	console.log('Save successfully !!!');
										getAllObjects()
									})
									break;
								default:
									break;
							}
						}
						else
						{
							// drawText("Too little input made. Please try again.");
						}
						_points.length = 0; // clear and signal to clear strokes on next mousedown
					}
				},1000)
			}
			else if (button == 2) // segmentation with right-click
			{
				if (_strokes.length > 1 || (_strokes.length == 1 && _strokes[0].length >= 10))
				{
					var text = new Array();
					for(let item of _strokes[0]){
						const el = document.elementsFromPoint(item.X+8,item.Y)
						if(el[1].innerText && el[1].innerText.length===1){
							text[text.length] = el[1].innerText
						}
					}
					_text = Array.from(new Set(text)).join('')
					console.log(_text);
					// alert(_text)
					var result = _r.Recognize(
						_strokes,
						false,
						true,
						false
						);
					// drawText("Result: " + result.Name + " (" + round(result.Score,2) + ") in " + result.Time + " ms.");
				}
				else
				{
					// drawText("Too little input made. Please try again.");
				}
				_points.length = 0; // clear and signal to clear strokes on next mousedown
			}
		}
		function drawConnectedPoint(from, to)
		{
			_g.beginPath();
			_g.moveTo(_points[from].X, _points[from].Y);
			_g.lineTo(_points[to].X, _points[to].Y);
			_g.closePath();
			_g.stroke();
		}
		function drawConnectedPointByPoints(points,from, to)
		{
			_g.beginPath();
			_g.moveTo(points[from].X, points[from].Y);
			_g.lineTo(points[to].X, points[to].Y);
			_g.closePath();
			_g.stroke();
		}
		function drawConnectedPointByPage(){
			var reg = /[\u3002|\uff1f|\uff01|\uff0c|\u3001|\uff1b|\uff1a|\u201c|\u201d|\u2018|\u2019|\uff08|\uff09|\u300a|\u300b|\u3008|\u3009|\u3010|\u3011|\u300e|\u300f|\u300c|\u300d|\ufe43|\ufe44|\u3014|\u3015|\u2026|\u2014|\uff5e|\ufe4f|\uffe5]/;
			for (const key in session) {
				var element = session[key]				
				if(element && element.stroke && element.stroke.points){
					//stroke color
					switch (key) {
						case 'person':
							clr = "rgb(" + 220 + "," + 96 + "," + 98 + ")";
							break;
						case 'time':
							clr = "rgb(" + 69 + "," + 139 + "," + 197 + ")";
							break;
						case 'place':
							clr = "rgb(" + 184 + "," + 214 + "," + 140 + ")";
							break;
						case 'event':
							clr = "rgb(" + 244 + "," + 197 + "," + 21 + ")";
							break;
						default:
							clr = "rgb(" + 0 + "," + 0 + "," + 0 + ")";
							break;
					}
					_g.strokeStyle = clr;
					//textdom bg
					var textDoms = [{id:''}]
					if(element.stroke.pageNum === page){
						var points = element.stroke.points
						for (let index = 0; index < points.length-1; index++) {
							//stroke
							drawConnectedPointByPoints(points,index,index+1)
							//textdom
							var point = points[index]
							const el = getDomElements(point.X,point.Y-10)
							if(el[1].innerText && el[1].innerText.length===1 && !reg.test(el[1].innerText)){
								if(el[1].id !== textDoms[textDoms.length-1].id){
										textDoms[textDoms.length] = el[1]
								}
							}
						}
						textDoms.shift()
						textDoms.forEach(dom => {
							dom.classList.add('text-bg')
						});
					}
				}
			}
		}
		function drawText(str)
		{
			_g.fillStyle = "rgb(255,255,255)";
			_g.fillRect(0, 0, _rc.width, 20);
			_g.fillStyle = "rgb(0,0,255)";
			_g.fillText(str, 1, 14);
		}
		function clearStroke(stroke)
		{
			var max_x=-Infinity,max_y=-Infinity;
			var min_x=Infinity,min_y=Infinity;
			for (const item of stroke) {
				if(item.X>max_x) max_x = item.X
				if(item.Y>max_y) max_y = item.Y
				if(item.X<min_x) min_x = item.X
				if(item.Y<min_y) min_y = item.Y
			}
			_g.clearRect(min_x-10,min_y-10,max_x-min_x+15,max_y-min_y+30);
		}
		function rand(low, high)
		{
			return Math.floor((high - low + 1) * Math.random()) + low;
		}
		function round(n, d) // round 'n' to 'd' decimals
		{
			d = Math.pow(10, d);
			return Math.round(n * d) / d;
		}
		function onClickClearStrokes()
		{
			console.log(_r);
			_points.length = 0; // clear and signal to clear strokes on next mousedown
			_g.clearRect(0, 0, _rc.width, _rc.height);
			drawText("Canvas cleared.");
		}
		function onClickAddFragment()
		{
			closeFragmentPanel()
			curSessionID = ''
			session = new Session()	
			_points.length = 0; // clear and signal to clear strokes on next mousedown
			// clear canvas
			_g.clearRect(0, 0, _rc.width, _rc.height);
			// clear textdom bg
			var textdoms = document.getElementsByClassName('text-bg')
			var textdomsNum = textdoms.length
			for (var i = 0; i < textdomsNum; i++) {
				textdoms[0].classList.remove('text-bg')
			}
			setTimeout(() => {
				openFragmentPanel()
			}, 1);
		}
		function onClickImportText()
		{
			const input = document.createElement('input')
			input.setAttribute('type','file')
			input.click()
			input.addEventListener('change', ()=>{
            const reader = new FileReader()
			reader.readAsText(input.files[0],'utf8') // input.files[0]为第一个文件
			reader.onload = ()=>{
                const text0=reader.result;
                const containerh=400;
				const fontPerLineNum = 100// 每行字数65
				const colPerPageNum = 22 // 每页行数15
				var fontPerPageNum =  fontPerLineNum * colPerPageNum // 每页最大字数
				let startIndex = 0 // text下标开始位置
				let endnum;
				const test0 = document.getElementById("test0")
				let pagecontent=1;
				while(startIndex < text0.length) 
				{
					test0.innerHTML="";
					var splitNum = fontPerPageNum // 首先使用最大字数测试
					test0.innerHTML= text0.substr(startIndex, splitNum)
					while(test0.scrollHeight < containerh && startIndex + splitNum - 1 <text0.length)
					{
						splitNum=splitNum+fontPerLineNum
						test0.innerHTML="";
						test0.innerHTML = text0.substr(startIndex, splitNum)
					}
					while (test0.scrollHeight > containerh) {
					splitNum =splitNum-20 // 如果高度超过，则每次减少一行字数的量
					test0.innerHTML="";
					test0.innerHTML= text0.substr(startIndex, splitNum)
					}
					while (test0.scrollHeight == containerh && startIndex + splitNum - 1 <text0.length) {
					//console.log(text0.substr(splitNum,1))
					splitNum += 1 // 高度<=页面高度，则每次增加1字符直到正好填满
					test0.innerHTML="";
					test0.innerHTML = text0.substr(startIndex, splitNum)
					}
					//判断最后一个字符即下一页第一个字符
					endnum=startIndex+splitNum
					if(pattern.test(text0.substr(endnum-1,1)))
					{
						while(1)
						{
							if(pattern.test(text0.substr(endnum-2,1)))
							{
								splitNum=splitNum-1
								endnum=endnum-1
							}
							else 
							{
								break;
							}
						}
					}
					textArray.push(text0.substr(startIndex, splitNum - 1))
					if(patterncontent.test(text0.substr(startIndex, splitNum - 1)))
					{
                       //console.log(pagecontent)
					}
					let lines = textArray[pagecontent-1].split("\n")//split() 方法用于把一个字符串分割成字符串数组。
					lines.forEach(element => {
					if(patterncontent.test(element))
					{
                       //console.log(element)
					   let cobj={pagenum:pagecontent, title:element}
					   menuArray.push(cobj)
					}
				    })			
					startIndex += splitNum - 1
					pagecontent+=1			
			 }
			 divfuzhi(page)
			 totalPageNum = textArray.length 
			 document.getElementById('totalPageNum').innerText = 'Total '+totalPageNum  // reader.result为获取结果
			 createMenu()
			 console.log(menuArray,'menuArray')
			 getAllObjects()
	   }, false})
	}
	function divfuzhi(i)
	{
		document.getElementById("text").innerText="";
		var lines = textArray[i].split("\n")//split() 方法用于把一个字符串分割成字符串数组。
		var str = ''
		lines.forEach(element => {
			var p = document.createElement('p')
			if(element.length >0){
				for(let char of element){
					var e = document.createElement('div')
						e.id = guid()
						e.innerHTML = char
						p.appendChild(e)
					
				}
				// var e = document.createElement('div')
				// e.innerHTML = "\r"
				document.getElementById('text').appendChild(p)
			}
		});
	    test0.innerHTML="";
		test0.innerHTML = textArray[page]
    }
	function createMenu() {
		for (const menuItem of menuArray) {
			var contentItem = document.createElement("div")
			contentItem.classList.add('content-item')
			var itemTitle = document.createElement("span")
			itemTitle.innerHTML = menuItem.title
			itemTitle.classList.add('item-title')
			var itemPage = document.createElement("span")
			itemPage.innerHTML = menuItem.pagenum
			itemPage.classList.add('item-page')
			contentItem.appendChild(itemTitle)
			contentItem.appendChild(itemPage)
			contentItem.addEventListener('click',function(){
				page = menuItem.pagenum - 1
				jumpPage(page)
				$('.menu-content').children().each(function(){
					$(this).removeClass('content-item-active')
				});
				$(this).addClass('content-item-active')
			})
			$('.menu-content').append(contentItem)
		}
		$('#float-panel-menu').addClass('float-panel-menu-active')
		$('.content-item').first().addClass('content-item-active')
	}

	function onClickOpenMenu() {
		if($('#float-panel-menu').hasClass('float-panel-menu-active')){
			$('#float-panel-menu').removeClass('float-panel-menu-active')
			$('#float-panel-menu').addClass('float-panel-menu-unactive')
		}else{
			$('#float-panel-menu').addClass('float-panel-menu-active')
			$('#float-panel-menu').removeClass('float-panel-menu-unactive')
		}	
	}

	function prepage() 
	{ 
		if(page-1>=0)
	    {
			page=page-1
			jumpPage(page)
		} 
	}	
	function nextpage() 
	{ 
		if( page+1 < textArray.length){			
			page=page+1
			// console.log('page',page);
			jumpPage(page)
		}
	}
	function onkeyupPageNumJump() {
		var input = document.getElementById('pageNumJump').value-1
		if(input>=0 && input<totalPageNum){
			if(window.event.keyCode === 13){			
				page = input
				jumpPage(page)
			}
		}
	}
	function jumpPage(page) {
		var res = classification(textArray[page])
		divfuzhi(page)
		_g.clearRect(0, 0, _rc.width, _rc.height);
		drawConnectedPointByPage()
		document.getElementById('curpage').innerText = page+1
		document.getElementById('pageNumJump').value = page+1

		//menu update
		var menuItemIndex = findMenuItem(page)
		$('.menu-content').children().each(function(){
			$(this).removeClass('content-item-active')
		});
		$(`.content-item:nth-child(${menuItemIndex})`).addClass('content-item-active')
		
		if((menuItemIndex - 1) <= 3){
			var curTransformY = 0
			$('.menu-content').scrollTop(curTransformY)
		}else if((menuItemIndex - 1) > 3 && (menuItemIndex - 1)<menuArray.length-3){
			var curTransformY = (menuItemIndex - 4) * 40
			$('.menu-content').scrollTop(curTransformY)
		}
	}
	function findMenuItem(page) {
		for (const menuItemIndex in menuArray) {
			var itemPage = menuArray[menuItemIndex].pagenum
			if(page+1<itemPage) return menuItemIndex
		}
		return menuArray.length
	}

	function getAllObjects() {
		getObjectFromDatabase().then(res=>{
			sessionListSL = new Array()
			sessionList = res.data
			eventCounter = 1
			//数据转换
			let str = "event,start,last,members,place,content\n";
			for (const eachSession of sessionList) {
				var min = Infinity,max = 0;
				for (const key in eachSession) {
					if (Object.hasOwnProperty.call(eachSession, key)) {
						const element = eachSession[key];
						if(element.stroke){
							if(element.stroke.pageNum > max) max = element.stroke.pageNum
							if(element.stroke.pageNum < min) min = element.stroke.pageNum
						}
					}
				}
				let l=max-min
				// var summarizationText = ''
				// for(var i = min; i <= max; i++){
				// 	summarizationText+=textArray[i]
				// }
				// var summarizationRes = summarization(summarizationText)
				// console.log(summarizationRes);
				sessionListSL.push([`i${eventCounter}`, min, l, eachSession.person.value,eachSession.place.value,eachSession.event.value,eachSession.time.value,eachSession._id])
				eventCounter++
			}

			console.log(sessionListSL,'sessionListSL');
			drawStoryLine(sessionListSL)
		})	
	}
	//chosen 选中
	function onmouseupElem(dom){
		var id = dom.id
		const floatPanelChosen = document.getElementById('float-panel-chosen')
		floatPanelChosen.style.display = 'none'
		//清空划线
		clearStroke(_strokes[0]);
		//赋予划线颜色
		var clr = ''
		switch (id) {
			case 'chosen-person':
				var person = new Object()
				_textValue= detectReg(_textValue)
				if(session.person.value === ''){
					person.value = _textValue
				}
				else{
					person.value = `${session.person.value},${_textValue}`
				}
				document.getElementById('person').value = person.value
				person.stroke = {
					pageNum:page,
					points:_strokes[0]
				}
				session.person = person
				clr = "rgb(" + 220 + "," + 96 + "," + 98 + ")";
				break;
			case 'chosen-time':
				var time = new Object()
				_textValue= detectReg(_textValue)
				document.getElementById('time').value = _textValue		
				time.value = _textValue
				time.stroke = {
					pageNum:page,
					points:_strokes[0]
				}
				session.time = time
				clr = "rgb(" + 69 + "," + 139 + "," + 197 + ")";
				break;
			case 'chosen-place':
				var place = new Object()
				_textValue= detectReg(_textValue)
				document.getElementById('place').value = _textValue		
				place.value = _textValue
				place.stroke = {
					pageNum:page,
					points:_strokes[0]
				}	
				session.place = place		
				clr = "rgb(" + 184 + "," + 214 + "," + 140 + ")";
				break;
			case 'chosen-event':
				var event = new Object()
				document.getElementById('event').value = _textValue		
				event.value = _textValue
				event.stroke = {
					pageNum:page,
					points:_strokes[0]
				}	
				session.event = event	
				clr = "rgb(" + 244 + "," + 197 + "," + 21 + ")";
				break;		
			default:
				break;
			}
		console.log(session);
		_g.strokeStyle = clr;
		for (let index = 0; index < _strokes[0].length-1; index++) {
			drawConnectedPointByPoints(_strokes[0],index,index+1)
		}	
	}
	function onmouseupFragmentCancel(dom){
		closeFragmentPanel()
	}
	function onmouseupFragmentConfirm(dom){
		console.log('confirm');
		_g.clearRect(0, 0, _rc.width, _rc.height);

		if(curSessionID === ''){ //new session
			session.curtime = transTimestamp()
			console.log(session);
			saveObjectIntoDatabase(session).then((status)=>{
				if(status === 200)	console.log('Save successfully !!!');
				getAllObjects()
			})
		}else{ // modify session
			console.log(session);
			findByIdAndUpdateObjectIntoDatabase(session).then((status)=>{
				if(status === 200)	console.log('Modify successfully !!!');
				getAllObjects()
			})
		}
		session=new Session()
		closeFragmentPanel()
		d3.selectAll(".WordCloud").remove();
	}

	//chosen界面input事件
	function onkeyupChosenText() {
		const chosenText = document.getElementById('chosen-text')	
		_textValue = chosenText.value
	}
	function onkeyupFragmentText(elemName){
		if(window.event.keyCode === 13){
			document.getElementById(elemName).blur()
		}
		switch (elemName) {
			case 'person':
				session.person.value = document.getElementById(elemName).value
				break;
			case 'time':
				session.time.value = document.getElementById(elemName).value
				break;
			case 'place':
				session.place.value = document.getElementById(elemName).value
				break;
			case 'event':
				session.event.value = document.getElementById(elemName).value
				break;
			default:
				break;
		}
	}
	</script>
</head>
<body onload="onLoadEvent()">
	<div class="outer-wrapper">
		<div class="panel-wrapper flex-panel-wrapper inner-wrapper">
			<div class="panel h-left-panel">
				<div class="panel-wrapper">
					<div class="panel v-panel panel-left-top">
						<div class="view">
							<div class="view-content menu-view-content">

							</div>
						</div>
					</div>
					<div class="panel v-panel panel-left-bottom">
						<div class="view">
							<div class="view-content overview-view-content">

							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="panel h-center-panel">
				<div class="panel-wrapper">
					<div class="panel v-panel panel-center-top" id="panel-center-top" >
						<div class="view">
						
							<div id="text-view" class="view-content text-view-content">
								<div class="nav">
									<div class="nav-tool-container">
										<span class="tool-btn" title="Open File"><span class="open-icon" onclick="onClickImportText()"></span></span>
										<span class="tool-btn" title="Menu" onclick="onClickOpenMenu()" ><img class="svg-icon" src="/img/menu.png"></span>
										<span class="tool-separator"></span>
										<span class="tool-btn" title="AddFragment" id="addFragment" onclick="onClickAddFragment()"><img class="svg-icon" src="/img/add.png"></span>
										<span class="tool-btn" title="Clear" id="clear" onclick="onClickClearStrokes()"><img class="svg-icon" src="/img/clear.png"></span>
									</div>
									<div class="nav-tool-container-right">
										<div class="page-container">
											<span class="tool-text-other" id="totalPageNum">Total 1</span>
											
											<span class="tool-btn" title="prepage" id="prepage" onclick="prepage()"><img class="svg-icon" src="/img/arrow.png"></span>
											<span class="tool-text-main" id="curpage">1</span>
											<span class="tool-btn" title="nextpage" id="nextpage" onclick="nextpage()"><img style="transform: rotateY(-180deg);" class="svg-icon" src="/img/arrow.png"></span>
											<span class="tool-text-other" >Go to</span>
											<input class="tool-text-input" type="text" id="pageNumJump" value="1" onkeyup="onkeyupPageNumJump()">
											
											
										</div>
									</div>
								</div>	
								<div id="text"></div>
								<div id="test0"></div>
						
								<canvas id="myCanvas" width="1000" height="400"
								onmousedown="mouseDownEvent(event.clientX, event.clientY, event.button)"
								onmousemove="mouseMoveEvent(event.clientX, event.clientY, event.button)"
								onmouseup="mouseUpEvent(event.clientX, event.clientY, event.button)"
								oncontextmenu="return false;">
									<span style="background-color:#ffff88;">The &lt;canvas&gt; element is not supported by this browser.</span>
								</canvas>
			
							</div>
						</div>
					</div>
					<div class="panel v-panel panel-center-bottom" id="panel-center-bottom" >
						<div class="view">
							<span id="storyline-view-title">Storyline</span>
							<div id="storyline-view" class="view-content storyline-view-content">
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="panel h-right-panel">
				<div class="panel-wrapper">
					<div class="panel v-panel panel-right-top">
						<div class="view">
							<div class="view-content relationship-view-content">

							</div>
						</div>
					</div>
					<div class="panel v-panel panel-right-bottom">
						<div class="view">
							<div class="view-content fragment-view-content">

							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div id="float-panel-menu" class="float-panel-menu">
		<div class="menu-wrapper">
			<div class="menu-header">Contents</div>
			<div class="menu-content">
				<!-- <div class="content-item active">
					<span class="item-title">第21回 女儿国唐三藏奇遇</span>
					<span class="item-page">01</span>
				</div> -->
			</div>
		</div>

	</div>
	<div id="float-panel-chosen" class="float-panel-chosen">
		<div class="text-wrapper">
			<!-- <div id="chosen-text" class="text"></div> -->
			<input type="text" id="chosen-text" class="text" onkeyup="onkeyupChosenText()">
		</div>
		<div class="elems-wrapper">
			<div id="chosen-person" class="elem-wrapper border-person" onmouseup="onmouseupElem(this)">
				<span class="elem-img"><img class="svg-icon" src="/img/person.png"></span>
				<div class="elem-text text-person">Person</div>
			</div>
			<div id="chosen-time" class="elem-wrapper border-time" onmouseup="onmouseupElem(this)">
				<span class="elem-img"><img class="svg-icon" src="/img/time.png"></span>
				<div class="elem-text text-time">Time</div>
			</div>
			<div id="chosen-place" class="elem-wrapper border-place" onmouseup="onmouseupElem(this)">
				<span class="elem-img"><img class="svg-icon" src="/img/place.png"></span>
				<div class="elem-text text-place">Place</div>
			</div>
			<div id="chosen-event" class="elem-wrapper border-event" onmouseup="onmouseupElem(this)">
				<span class="elem-img"><img class="svg-icon" src="/img/event.png"></span>
				<div class="elem-text text-event">Event</div>
			</div>
		</div>
	</div>
	<div id="float-panel-fragment" class="float-panel-fragment">
		<div id="fragments-top" class="fragments-top">
			<div id="fragment-cancel" class="fragment-cancel" onmouseup="onmouseupFragmentCancel(this)">
				<span class="cancel-img"><img class="svg-icon" src="/img/cancel.png"></span>
			</div>
			<div id="fragment-header" class="text">Session</div>
			<div id="fragment-confirm" class="fragment-confirm" onmouseup="onmouseupFragmentConfirm(this)">
				<span class="confirm-img"><img class="svg-icon" src="/img/confirm.png"></span>
			</div>
		</div>
		
		<div class="fragments-wrapper">
			<div class="fragment-wrapper border-person" style="margin-top:20px">
				<span class="fragment-img"><img class="svg-icon" src="/img/person-fill.png"></span>
				<div class="fragment-text text-person">Person</div>
				<span class="fragment-separator"></span>

				<input type="text" id="person" class="fragment-content" onkeyup="onkeyupFragmentText('person')">
			</div>
			<div class="fragment-wrapper border-time">
				<span class="fragment-img"><img class="svg-icon" src="/img/time-fill.png"></span>
				<div class="fragment-text text-time">Time</div>
				<span class="fragment-separator"></span>
				
				<input type="text" id="time" class="fragment-content" onkeyup="onkeyupFragmentText('time')">
			</div>
			<div class="fragment-wrapper border-place">
				<span class="fragment-img"><img class="svg-icon" src="/img/place-fill.png"></span>
				<div class="fragment-text text-place">Place</div>
				<span class="fragment-separator"></span>

				<input type="text" id="place" class="fragment-content" onkeyup="onkeyupFragmentText('place')">
			</div>
			<div class="fragment-wrapper border-event">
				<span class="fragment-img"><img class="svg-icon" src="/img/event-fill.png"></span>
				<div class="fragment-text text-event">Event</div>
				<span class="fragment-separator"></span>

				<input type="text" id="event" class="fragment-content" onkeyup="onkeyupFragmentText('event')">
			</div>

		</div>
	</div>
	<defs>
        <!-- 添加带箭头的标线 -->
        <marker
          id="markerArrow"
          markerWidth="8"
          markerHeight="8"
          refx="2"
          refy="5"
          orient="auto"
        >
          <path d="M2,2 L2,8 L8,5 L2,2" style="fill: #61a8e0" />  
        </marker>
    </defs>
</body>
<script type="text/javascript">
	dragFuncIndex('float-panel-fragment','fragments-top')
</script>
</html>