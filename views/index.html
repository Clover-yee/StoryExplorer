<!--
 * @Author: Clover 304363641@qq.com
 * @Date: 2022-07-21 11:53:13
 * @LastEditors: Clover 304363641@qq.com
 * @LastEditTime: 2022-11-16 12:51:14
 * @FilePath: \storyline-generator\views\index.html
 * @Description: 
 * 
 * Copyright (c) 2022 by Clover 304363641@qq.com, All Rights Reserved. 
-->
<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>StoryCreator</title>
	<!--[if IE]><script src="excanvas.js"></script><![endif]-->
	<script src="js/lib/axios.min.js"></script>
	<!-- 新 Bootstrap5 核心 CSS 文件 -->
	<link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/5.1.1/css/bootstrap.min.css">
	<!--  popper.min.js 用于弹窗、提示、下拉菜单 -->
	<script src="https://cdn.staticfile.org/popper.js/2.9.3/umd/popper.min.js"></script>
	<!-- 最新的 Bootstrap5 核心 JavaScript 文件 -->
	<script src="https://cdn.staticfile.org/twitter-bootstrap/5.1.1/js/bootstrap.min.js"></script>
	<script src="https://cdn.bootcss.com/wordcloud2.js/1.1.0/wordcloud2.js"></script>

	<link href="css/styles.css" rel="stylesheet" type="text/css" />
	<link href="css/menu.view.css" rel="stylesheet" type="text/css" />
	<link href="css/fragment.view.css" rel="stylesheet" type="text/css" />
	<link href="css/overview.css" rel="stylesheet" type="text/css" />
	<link href="css/configuration.view.css" rel="stylesheet" type="text/css" />
	<link href="css/lib/jquery.range.css" rel="stylesheet" type="text/css" />


	<script type="text/javascript" src="js/canvas.text.js"></script>
	<script type="text/javascript" src="js/faces/gentilis-normal-normal.js"></script>
	<script type="text/javascript" src="js/jquery-1.7.2.min.js"></script>
	<script type="text/javascript" src="js/d3.js"></script>
	<script type="text/javascript" src="js/lib/jquery.range.js"></script>
    <script src="js/d3.layout.cloud.js"></script>
	<script src="js/echart.js"></script>
    <script src="js/echarts-wordcloud.js"></script>
	<script type="text/javascript" src="js/ndollar.js"></script>
	<script type="text/javascript" src="js/storyline.js"></script>
	<script type="text/javascript" src="js/database.js"></script>
	<script type="text/javascript" src="js/session.js"></script>
	<script type="text/javascript" src="js/utils.js"></script>
	<script type="text/javascript" src="js/panel.js"></script>

	<script type="text/javascript" src="js/fragment.view.js"></script>
	<script type="text/javascript" src="js/entity.view.js"></script>
	<script type="text/javascript" src="js/menu.view.js"></script>



	<script type="text/javascript">
		//
		// Startup
		//
		var _isDown, _points, _strokes, _r, _g, _rc,_isStart; // global variables
		var isImportText=false,isNerEnable=true,isTsEnable=true//configration variables
		var chooseStatus = 'stroke/recognition' // chosen-panel响应的标记 stroke or recognition
		var isRecognition = false;

		var sessionList = new Array()
		var session = new Session()
		var curEntityId = '' //当前更改或删除的实体ID NLP/DICT
		var curSessionID =''
		var curSessionDetail = new Object() //for Fragment View
		var sessionTemplate = new Array() //保存自动识别实体的数组

		//状态保存
		var iconStatus = {
			isHighLight : true,
			isModify : false,
			isDelete : false
		}
		var curStart = ''
		var curEnd = ''

		var pageEntityList = new Array()
		var pageEntityDeleteList = new Array()
		var pageEntityModifyList = new Array()
		var pageStrokeList = new Array()

		//i1,i2...
		var eventCounter = 0;

		var page=0;
		var totalPageNum = 0;
		var pageWords = []
		var pageHighLight = []

		var textArray = []
	    var pattern = new RegExp("[A-Za-z]+");
		//var patterncontent= new RegExp("[/\\x{7b2c}+/w+\\x{56de}/u]")
		// var patterncontent=  /第[0-9][0-9]回/
		var patterncontent=  /Chapter/
		var menuArray = []
		
		var entityDict = new Array()

		document.ontouchstart = null;
		document.ontouchmove = null;
		document.ontouchend = null;

		function onLoadEvent()
		{
			_points = new Array(); // point array for current stroke
			_strokes = new Array(); // array of point arrays
			_text = new Array();//array of regonize text
			_textValue = ''
			_r = new NDollarRecognizer(true);

			var canvas = document.getElementById('myCanvas');
			_g = canvas.getContext('2d');
			_g.lineWidth = 2;
			_g.lineCap = 'round'
			_g.lineJoin = 'round'
			_g.font = "16px Gentilis";
			_rc = getCanvasRect(canvas); // canvas rect on page
			// _g.fillStyle = "rgb(255,255,136)";
			// _g.fillRect(0, 0, _rc.width, 20);

			_isDown = false;
			_isStart = false
		}
		function getCanvasRect(canvas)
		{
			var w = canvas.width;
			var h = canvas.height;

			var cx = canvas.offsetLeft;
			var cy = canvas.offsetTop;
			while (canvas.offsetParent != null)
			{
				canvas = canvas.offsetParent;
				cx += canvas.offsetLeft;
				cy += canvas.offsetTop;
			}
			return {x: cx, y: cy, width: w, height: h};
		}
		function getScrollX()
		{
			var scrollX = $(window).scrollLeft();
			return scrollX;
		}
		function getScrollY()
		{
			var scrollY = $(window).scrollTop();
			return scrollY;
		}
		function getDomElements(x,y){
			var left = $("#text").offset().left
			var top = $("#text").offset().top
			return document.elementsFromPoint(x+left,y+top)
		}
		function getPageEntity() {
			var pageEntity = pageEntityList.find(item=>{
				console.log(item.page);
				return item.page === page
			})
			return pageEntity
		}
		function getEntity(id) {
			var pageEntity = pageEntityList.find(item=>{
				return item.page === page
			})
			var entity = pageEntity.entityList.find(item => {
				return item.id === id 
			})
			return entity
		}
		function getPageStroke() {
			var pageStroke = pageStrokeList.find(item=>{
				return item.page === page
			})
			return pageStroke
		}
		function getPageStrokeEntity(str) {
			var pageStroke = pageStrokeList.find(item=>{
				return item.page === page
			})
			var entity = pageStroke.entityList.find(item=>{
				return item.str === str
			})
			return entity
		}
		function removePageStrokeEntity(str) {
			var pageStroke = pageStrokeList.find(item=>{
				return item.page === page
			})
			var entityIndex = pageStroke.entityList.findIndex(item=>{
				return item.str === str
			})
			pageStroke.entityList.splice(entityIndex,1)
		}
		function reDrawFragmentView() {
			
			//去重
			var obj = {}
			var sessionTemplateOrigin = sessionTemplate
			sessionTemplateOrigin.forEach(eachSessionTemplateOrigin => {
					obj[eachSessionTemplateOrigin.str] = eachSessionTemplateOrigin
			});
			sessionTemplate = []
			for (let key in obj) {
				sessionTemplate.push(obj[key])
			}
			//整理故事片段
			var persons_array = entityDict 
			var page_max = totalPageNum
			let templatePersons='',templatePlace='',templateTime='',templateEvent='';
			console.log(sessionTemplate);
			session.person.entities=[]
			sessionTemplate.forEach(item=>{
				let key = item.type.substr(-3)
				switch (key) {
					case 'PER':
						if (templatePersons) {
							templatePersons = `${templatePersons},${item.str}`
						}else{
							templatePersons = item.str
						}
						if(persons_array.findIndex(each=>{
							return each === item.str
						}) === -1){
							persons_array.push(item.str)
						}

						//组织session
						session.person.value = templatePersons
						if(item.points){
							session.person.entities.push({
								str:item.str,
								pageNum:item.page,
								points:item.points
							})
						}else{
							session.person.entities.push({
								str:item.str,
								pageNum:item.page
							})
						}
						break;
					case 'TIM':
						templateTime = item.str
						session.time.value = templateTime
						session.time.stroke={
							pageNum : item.page,
							points:item.points
						}
						break;
					case 'LOC':
						templatePlace = item.str
						session.place.value = templatePlace
						if(item.points){
							session.place.stroke={
								pageNum : item.page,
								points:item.points
							}
						}else{
							session.place.stroke={
								pageNum : item.page
							}
						}
						break;
					case 'EVT':
						templateEvent = item.str
						session.event.value = templateEvent
						session.event.stroke={
							pageNum : item.page,
							points:item.points
						}
						break;
				}
			})
			session.highlight = pageHighLight
			session.curtime = transTimestamp()
			let startPage,endPage
			if(pageHighLight.length === 0){
				startPage = 0
				endPage = 20
			}else{
				startPage = pageHighLight[0].page
				endPage = pageHighLight[pageHighLight.length-1].page
			}
			var data = [
				{
					page_start:startPage,
					page_end:endPage,
					persons:templatePersons,
					place:templatePlace,
					time:templateTime,
					event:templateEvent
				}
			]
			curSessionDetail = data

			console.log(curSessionDetail);
			console.log(session);
			drawFragmentView(curSessionDetail,persons_array,page_max)   
		}
		//
		// Mouse Events
		//
		function mouseDownEvent(x, y, button)
		{
			document.onselectstart = function() { return false; } // disable drag-select
			// document.onmousedown = function() { return false; } // disable drag-select
			if (button <= 1)
			{
			console.log(x,y);

				_isDown = true;
				x -= _rc.x - getScrollX();
				y -= _rc.y - getScrollY();
				if (_points.length == 0)
				{
					_strokes.length = 0;
					// _g.clearRect(0, 0, _rc.width, _rc.height);
				}
				_points.length = 1; // clear
				_points[0] = new Point(x, y);
				// drawText("Recording stroke #" + (_strokes.length + 1) + "...");
				var clr = "rgba(" + 0 + "," + 0 + "," + 0 + "," + 1 +")";
				_g.strokeStyle = clr;
				_g.fillStyle = clr;
				// _g.fillRect(x - 4, y - 3, 3, 3);
			}
			else if (button == 2)
			{
				// drawText("Recognizing gesture...");
			}
		}
		function mouseMoveEvent(x, y, button)
		{
			if (_isDown)
			{
				x -= _rc.x - getScrollX();
				y -= _rc.y - getScrollY();
				_points[_points.length] = new Point(x, y); // append
				drawConnectedPoint(_points.length - 2, _points.length - 1);
			}
		}
		function mouseUpEvent(x, y, button)
		{
			document.onselectstart = function() { return true; } // enable drag-select
			document.onmousedown = function() { return true; } // enable drag-select

			const pointDoms = document.elementsFromPoint(x,y)
			pointDoms[1].click()
			pointDoms[2].click()

			if (button <= 1)
			{
				if (_isDown)
				{
					_isDown = false;
					_strokes[_strokes.length] = _points.slice(); // add new copy to set
					// drawText("Stroke #" + _strokes.length + " recorded.");
				}
				setTimeout(()=>{
					if(_isDown){
						console.log('isDown');
					}else{
						if (_strokes.length > 1 || (_strokes.length == 1 && _strokes[0].length >= 10))
						{ 
							var text = new Array();
							var result = _r.Recognize(
								_strokes,
								true,
								true,
								false
								);
							// drawText("Result: " + result.Name + " (" + round(result.Score,2) + ") in " + result.Time + " ms.");
							console.log(_strokes[0]); //TODO
							console.log(result);
							switch (result.Name) {
								case 'line/person':
									isRecognition = false
									var textDoms = [{id:''}]
									var _text = []
									for(let item of _strokes[0]){
										const el = getDomElements(item.X,item.Y-10)
										if(el[1].innerText && el[1].innerText.length===1 ){
											if(el[1].id !== textDoms[textDoms.length-1].id){
													textDoms[textDoms.length] = el[1]
											}
										}
									}
									textDoms.shift()
									textDoms.forEach(dom => {
										_text[_text.length] = dom.innerText
									});
									_textValue = _text.join('')		
									//块级作用域用以点击事件
									var textValueBlock = _textValue
									textDoms.forEach(dom1=>{
										//划线点击事件1
										dom1.addEventListener('click',strokeDeleteClickFuncion)
										function strokeDeleteClickFuncion(){
											let curEntity = getPageStrokeEntity(textValueBlock)
											if(iconStatus.isDelete){
												//相同元素删除
												textDoms.forEach(dom2 => {
													// dom2.classList.remove('text-bg')
													dom2.removeEventListener('click',strokeDeleteClickFuncion)
												});
												clearStroke(curEntity.points)
												removePageStrokeEntity(textValueBlock)
												console.log(pageStrokeList);
											}
										}		
									})

									//弹出面板
									const floatPanelChosen = document.getElementById('float-panel-chosen')
									const chosenText = document.getElementById('chosen-text')	
									var top = _strokes[0][_strokes[0].length-1].Y					
									var left = _strokes[0][_strokes[0].length-1].X
									var leftOffset = $("#text").offset().left+10
									var topOffset = $("#text").offset().top+10
									floatPanelChosen.style.display = 'block'
									floatPanelChosen.style.top = top+topOffset+'px'
									if(left+leftOffset+250 > document.body.clientWidth){
										floatPanelChosen.style.left = ''
										floatPanelChosen.style.right = '10px'
									}else{
										floatPanelChosen.style.right = ''
										floatPanelChosen.style.left = left+leftOffset+'px'
									}
									chosenText.value = _textValue
									break;
								case 'circle/time':
									var textDoms = [{id:''}]
									var _text = []
									var time = new Object()
									var max_x=-Infinity,max_y=-Infinity;
									var min_x=Infinity,min_y=Infinity;
									for (const item of _strokes[0]) {
										if(item.X>max_x) max_x = item.X
										if(item.Y>max_y) max_y = item.Y
										if(item.X<min_x) min_x = item.X
										if(item.Y<min_y) min_y = item.Y
									}
									console.log(min_x,max_x);
									console.log(min_y,max_y);
									for (let x = min_x; x < max_x; x++) {
										for (let y = min_y; y < max_y; y++) {
											const el = getDomElements(x,y)
											if(el[1].innerText && el[1].innerText.length===1){
												if(el[1].id !== textDoms[textDoms.length-1].id){
													textDoms[textDoms.length] = el[1]
												}
											}
										}
									}
									textDoms.shift()
									textDoms.shift()
									textDoms.pop()
									textDoms.forEach(dom => {
										_text[_text.length] = dom.innerText
									});
									_text= _text.join('')
									document.getElementById('time').innerText = _text
									time.value = _text
									time.stroke = {
										pageNum:page,
										points:_strokes[0]
									}
									session.time = time
									break;		
								case 'wave/content':
									var textDoms = [{id:''}]
									var _text = []
									var event = new Object()
									for(let item of _strokes[0]){
										const el_half = getDomElements(item.X,item.Y-10)
										if(el_half[1].innerText && el_half[1].innerText.length===1 && !reg.test(el_half[1].innerText)){
											if(el_half[1].id !== textDoms[textDoms.length-1].id){
													textDoms[textDoms.length] = el_half[1]
											}
											// text[text.length] = el_half[1].innerText
										}
										const el_all = getDomElements(item.X,item.Y-20)
										if(el_all[1].innerText && el_all[1].innerText.length===1 && !reg.test(el_all[1].innerText)){
											if(el_all[1].id !== textDoms[textDoms.length-1].id){
													textDoms[textDoms.length] = el_all[1]
											}
											// text[text.length] = el_all[1].innerText
										}
									}
									textDoms.shift()
									textDoms.forEach(dom => {
										_text[_text.length] = dom.innerText
									});
									_text= _text.join('')
									document.getElementById('event').innerText = _text
									event.value = _text
									event.stroke = {
										pageNum:page,
										points:_strokes[0]
									}
									session.event = event
									break;
								case 'brkoen/place':
									var textDoms = [{id:''}]
									var _text = []
									var place = new Object()
									for(let item of _strokes[0]){
										const el = getDomElements(item.X,item.Y-10)
										if(el[1].innerText && el[1].innerText.length===1 && !reg.test(el[1].innerText)){
											if(el[1].id !== textDoms[textDoms.length-1].id){
													textDoms[textDoms.length] = el[1]
												}
										}
									}
									textDoms.shift()
									const el = document.elementsFromPoint(_strokes[0][0].X,_strokes[0][0].Y)
									if(el[1].innerText.length === 1){
										textDoms.shift()
									}
									textDoms.forEach(dom => {
										_text[_text.length] = dom.innerText
									});
									_text= _text.join('')
									document.getElementById('place').innerText = _text		
									place.value = _text
									place.stroke = {
										pageNum:page,
										points:_strokes[0]
									}	
									session.place = place														
									break;		
								case 'left/start':
									_isStart = true
									
									var stroke = _strokes[0]
									curStart.value ={
										top:{
											X:_strokes[0][0].X+$("#text").offset().left,
											Y:_strokes[0][0].Y+$("#text").offset().top
										},
										bottom:{
											X:_strokes[0][parseInt(_strokes[0].length/2)].X+$("#text").offset().left,
											Y:_strokes[0][parseInt(_strokes[0].length/2)].Y+$("#text").offset().top
										}
									}
									curStart.stroke = {
										pageNum:page,
										points:stroke
									}
									console.log(curStart);	
									// session = new Session();
									// session.start = start	
									break;
								case 'right/end':									
									var stroke = _strokes[0]
									curEnd.value ={
										top:{
											X:_strokes[0][parseInt(_strokes[0].length/2)].X+$("#text").offset().left,
											Y:_strokes[0][parseInt(_strokes[0].length/2)].Y+$("#text").offset().top
										},
										bottom:{
											X:_strokes[0][_strokes[0].length - 1].X+$("#text").offset().left,
											Y:_strokes[0][_strokes[0].length - 1].Y+$("#text").offset().top
										}
									}
									curEnd.stroke = {
										pageNum:page,
										points:stroke
									}	
									console.log(curEnd);
									let pageStart = curStart.stroke.pageNum
									let pageEnd = curEnd.stroke.pageNum	
									let sessionTemplateOrigin = new Array()

									for (let pageNum = pageStart; pageNum <= pageEnd; pageNum++) {
										let res
										var pageEntity = pageEntityList.find(item=>{
											return item.page === pageNum
										})
										var strokeEntity = pageStrokeList.find(item=>{
											return item.page === pageNum
										})
										if(pageNum === pageStart){
											res = pageEntity.entityList.filter(entity=>{
												if(entity.top>curStart.value.bottom.Y || 
												((entity.top >= curStart.value.top.Y && entity.top <= curStart.value.bottom.Y)  
																						&& entity.left >= curStart.value.top.X)){
													return true
												}else{
													return false
												}
											})
										}else if(pageNum === pageEnd){
											res = pageEntity.entityList.filter(entity=>{
												if(entity.bottom<curEnd.value.top.Y || 
												((entity.bottom >= curEnd.value.top.Y && entity.bottom <= curEnd.value.bottom.Y)  
																						&& entity.right <= curEnd.value.top.X)){
													return true
												}else{
													return false
												}
											})
										}else{
											res = pageEntity.entityList
										}
										res = res.concat(strokeEntity.entityList)
										let eachSessionTemplate = {
											page:pageEntity.page,
											entityList:res
										}
										sessionTemplateOrigin.push(eachSessionTemplate)
									}
									console.log(sessionTemplateOrigin); //right event
									

									//去重
									var obj = {}
									sessionTemplateOrigin.forEach(eachSessionTemplateOrigin => {
										eachSessionTemplateOrigin.entityList.forEach(entity => {
											obj[entity.str] = entity
										});
									});
									sessionTemplate = []
									for (let key in obj) {
										sessionTemplate.push(obj[key])
									}

									console.log(sessionTemplate);
                    
									//整理故事片段
									var persons_array = entityDict 
									var page_max = totalPageNum
									let templatePersons,templatePlace,templateTime,templateEvent;
									sessionTemplate.forEach(item=>{
										let key = item.type.substr(-3)
										switch (key) {
											case 'PER':
												if (templatePersons) {
													templatePersons = `${templatePersons},${item.str}`
												}else{
													templatePersons = item.str
												}
												if(persons_array.findIndex(each=>{
													return each === item.str
												}) === -1){
													persons_array.push(item.str)
												}

												//组织session
												session.person.value = templatePersons
												if(item.points){
													session.person.entities.push({
														str:item.str,
														pageNum:item.page,
														points:item.points
													})
												}else{
													session.person.entities.push({
														str:item.str,
														pageNum:item.page
													})
												}
												break;
											case 'TIM':
												templateTime = item.str
												session.time.value = templateTime
												session.time.stroke={
													pageNum : item.page,
													points:item.points
												}
												break;
											case 'LOC':
												templatePlace = item.str
												session.place.value = templatePlace
												if(item.points){
													session.place.stroke={
														pageNum : item.page,
														points:item.points
													}
												}else{
													session.place.stroke={
														pageNum : item.page
													}
												}
												break;
											case 'EVT':
												templateEvent = item.str
												session.event.value = templateEvent
												session.event.stroke={
													pageNum : item.page,
													points:item.points
												}
												break;
										}
									})
									session.start = {
										value:curStart.stroke.pageNum,
										stroke:{
											points:curStart.stroke.points
										}
									}
									session.end = {
										value:curEnd.stroke.pageNum,
										stroke:{
											points:curEnd.stroke.points
										}
									}
									session.curtime = transTimestamp()
									var data = [
										{
											page_start:curStart.stroke.pageNum,
											page_end:curEnd.stroke.pageNum,
											persons:templatePersons,
											place:templatePlace,
											time:templateTime,
											event:templateEvent
										}
									]
                        			curSessionDetail = data
						
									console.log(curSessionDetail);
									console.log(session);
									
									
									drawFragmentView(curSessionDetail,persons_array,page_max)    

									//text summarization
									if(isTsEnable){
										var summarizationText = textArray[page]
										summarization(summarizationText).then(summarizationRes=>{
											var resStr = ''
											console.log(summarizationRes);
											summarizationRes.forEach(each => {
												resStr += each['summary_text']
											});
											$('#event_input').val(resStr)
										})
									}

									break;
								default:
									break;
							}
						}
						else
						{
							// drawText("Too little input made. Please try again.");
						}
						_points.length = 0; // clear and signal to clear strokes on next mousedown
					}
				},1000)
			}
			else if (button == 2) // segmentation with right-click
			{
				if (_strokes.length > 1 || (_strokes.length == 1 && _strokes[0].length >= 10))
				{
					var text = new Array();
					for(let item of _strokes[0]){
						const el = document.elementsFromPoint(item.X+8,item.Y)
						if(el[1].innerText && el[1].innerText.length===1){
							text[text.length] = el[1].innerText
						}
					}
					_text = Array.from(new Set(text)).join('')
					console.log(_text);
					// alert(_text)
					var result = _r.Recognize(
						_strokes,
						false,
						true,
						false
						);
					// drawText("Result: " + result.Name + " (" + round(result.Score,2) + ") in " + result.Time + " ms.");
				}
				else
				{
					// drawText("Too little input made. Please try again.");
				}
				_points.length = 0; // clear and signal to clear strokes on next mousedown
			}
		}
		function drawConnectedPoint(from, to)
		{
			_g.beginPath();
			_g.moveTo(_points[from].X, _points[from].Y);
			_g.lineTo(_points[to].X, _points[to].Y);
			_g.closePath();
			_g.stroke();
		}
		function drawConnectedPointByPoints(points,from, to)
		{
			_g.beginPath();
			_g.moveTo(points[from].X, points[from].Y);
			_g.lineTo(points[to].X, points[to].Y);
			_g.closePath();
			_g.stroke();
		}
		function drawConnectedPointByPage(){	//界面划线
			var reg = /[\u3002|\uff1f|\uff01|\uff0c|\u3001|\uff1b|\uff1a|\u201c|\u201d|\u2018|\u2019|\uff08|\uff09|\u300a|\u300b|\u3008|\u3009|\u3010|\u3011|\u300e|\u300f|\u300c|\u300d|\ufe43|\ufe44|\u3014|\u3015|\u2026|\u2014|\uff5e|\ufe4f|\uffe5]/;
			let pageStrokeListIndex = pageStrokeList.findIndex(item=>{
				return item.page === page
			})
			let curStrokeList = pageStrokeList[pageStrokeListIndex].entityList
			
			curStrokeList.forEach(entity => {
				//stroke color
				let key = entity.type.substr(-3)
				var bg = ''
				switch (key) {
					case 'PER':
						clr = "rgb(" + 220 + "," + 96 + "," + 98 + ")";
						bg = 'entity-dict-bg'
						break;
					case 'TIM':
						clr = "rgb(" + 69 + "," + 139 + "," + 197 + ")";
						bg = 'time-dict-bg'
						break;
					case 'LOC':
						clr = "rgb(" + 184 + "," + 214 + "," + 140 + ")";
						bg = 'place-dict-bg'
						break;
					case 'EVT':
						clr = "rgb(" + 244 + "," + 197 + "," + 21 + ")";
						bg = 'event-dict-bg'
						break;
					default:
						clr = "rgb(" + 0 + "," + 0 + "," + 0 + ")";
						break;
				}
				
				_g.strokeStyle = clr;
				//textdom bg
				var textDoms = [{id:''}]
				var points = entity.points
				if(points.length!==0){
					//stroke
					drawConnectedPointByPoints(points,0,points.length-1)
	
					for (let index = 0; index < points.length-1; index++) {
						//textdom
						var point = points[index]
						const el = getDomElements(point.X,point.Y-10)
						var domText 
						if(el[0].tagName === 'CANVAS '){
							domText = el[1]
						}else{
							domText = el[0]
						}
						// console.log(el[0].tagName,el[1].tagName);
						if(domText.innerText && domText.innerText.length===1 && !reg.test(domText.innerText)){
							if(domText.id !== textDoms[textDoms.length-1].id){
									textDoms[textDoms.length] = domText
							}
						}
					}
					textDoms.shift()
					textDoms.forEach(dom1 => {
						dom1.classList.remove('text-bg')
						dom1.classList.add(bg)
						//划线点击事件2
						dom1.addEventListener('click',strokeDeleteClickFuncion)
						function strokeDeleteClickFuncion(e){
							let curEntity = getPageStrokeEntity(entity.str)
							if(iconStatus.isDelete){
								//相同元素删除
								textDoms.forEach(dom2 => {
									// dom2.classList.remove('text-bg')
									dom2.removeEventListener('click',strokeDeleteClickFuncion)
								});
								clearStroke(curEntity.points)
								removePageStrokeEntity(entity.str)
								console.log(pageStrokeList);
							}
						}		
					});
				}
			});
		}
		function drawHighLightByPage() {
			session.highlight.forEach(eachHighLight=>{
				if(page === eachHighLight.page){
					var startId = eachHighLight.startId
					var endId = eachHighLight.endId
					if(endId-startId >= 3){ //解决修改时选中单个字母背景变色问题
						for (let i = startId; i <= endId; i++) {
							var dom = document.getElementById(`${page}-${i}`)
							dom.classList.add('text-bg')
						}
					}
					var pageEntity = pageEntityList.find(item=>{
						return item.page === page
					})
					pageEntity.entityList.forEach(item=>{
						let entityStartIndex = eachHighLight.str.indexOf(item.str)
						if(entityStartIndex !== -1){
							// sessionTemplate.push(item)
							// console.log(`${page}-${startId+entityStartIndex}`,document.getElementById(`${page}-${startId+entityStartIndex}`));
							// console.log(document.getElementById(`${page}-${startId+entityStartIndex}`).parentNode);
							var dom = document.getElementById(`${page}-${startId+entityStartIndex}`).parentNode
							if(dom.tagName !== 'P'){
								switch (item.type) {
									case 'Dict-PER':
										dom.classList.add('entity-dict-bg')	
										break;
									case 'Dict-LOC':
										dom.classList.add('place-dict-bg')	
										break;
									case 'NLP-PER':
										dom.classList.add('entity-nlp-bg')	
										break;
									case 'NLP-LOC':
										dom.classList.add('place-nlp-bg')	
										break;
									default:
										break;
								}
								dom.childNodes.forEach(child=>{
									child.classList.remove('text-bg')
								})
							}
						
						}
					})
				}
			})
		}
		function drawText(str)
		{
			_g.fillStyle = "rgb(255,255,255)";
			_g.fillRect(0, 0, _rc.width, 20);
			_g.fillStyle = "rgb(0,0,255)";
			_g.fillText(str, 1, 14);
		}
		function clearStroke(stroke)
		{
			//清除划线
			var max_x=-Infinity,max_y=-Infinity;
			var min_x=Infinity,min_y=Infinity;
			for (const item of stroke) {
				if(item.X>max_x) max_x = item.X
				if(item.Y>max_y) max_y = item.Y
				if(item.X<min_x) min_x = item.X
				if(item.Y<min_y) min_y = item.Y
			}
			_g.clearRect(min_x-10,min_y-10,max_x-min_x+15,max_y-min_y+30);

		}
		function clearTextBg(stroke) {
			//清除背景
			var textDoms = [{id:''}]
			for(let item of stroke){
				const el = getDomElements(item.X,item.Y-10)
				if(el[1].innerText && el[1].innerText.length===1 ){
					if(el[1].id !== textDoms[textDoms.length-1].id){
							textDoms[textDoms.length] = el[1]
					}
				}
			}
			textDoms.shift()
			textDoms.forEach(dom => {
				dom.classList.remove('text-bg')
			});
		}
		function onClickClearStrokes()
		{
			console.log(_r);
			_points.length = 0; // clear and signal to clear strokes on next mousedown
			_g.clearRect(0, 0, _rc.width, _rc.height);
			// drawText("Canvas cleared.");
		}
		function onClickAddFragment()
		{
			curSessionID = ''
			session = new Session()	
			_points.length = 0; // clear and signal to clear strokes on next mousedown
			// clear canvas
			_g.clearRect(0, 0, _rc.width, _rc.height);
			// clear textdom bg
			var textdoms = document.getElementsByClassName('text-bg')
			var textdomsNum = textdoms.length
			for (var i = 0; i < textdomsNum; i++) {
				textdoms[0].classList.remove('text-bg')
			}
			setTimeout(() => {
				openFragmentPanel()
			}, 1);
		}
		function onClickImportText()
		{
			isImportText= true
			const input = document.createElement('input')
			input.setAttribute('type','file')
			input.click()
			input.addEventListener('change', ()=>{
            const reader = new FileReader()
			reader.readAsText(input.files[0],'utf8') // input.files[0]为第一个文件
			reader.onload = ()=>{
                const text0=reader.result;
                const containerh=400;
				const fontPerLineNum = 100// 每行字数65
				const colPerPageNum = 22 // 每页行数15
				var fontPerPageNum =  fontPerLineNum * colPerPageNum // 每页最大字数
				let startIndex = 0 // text下标开始位置
				let endnum;
				const test0 = document.getElementById("test0")
				let pagecontent=1;
				while(startIndex < text0.length) 
				{
					test0.innerHTML="";
					var splitNum = fontPerPageNum // 首先使用最大字数测试
					test0.innerHTML= text0.substr(startIndex, splitNum)
					while(test0.scrollHeight < containerh && startIndex + splitNum - 1 <text0.length)
					{
						splitNum=splitNum+fontPerLineNum
						test0.innerHTML="";
						test0.innerHTML = text0.substr(startIndex, splitNum)
					}
					while (test0.scrollHeight > containerh) {
					splitNum =splitNum-20 // 如果高度超过，则每次减少一行字数的量
					test0.innerHTML="";
					test0.innerHTML= text0.substr(startIndex, splitNum)
					}
					while (test0.scrollHeight == containerh && startIndex + splitNum - 1 <text0.length) {
					//console.log(text0.substr(splitNum,1))
					splitNum += 1 // 高度<=页面高度，则每次增加1字符直到正好填满
					test0.innerHTML="";
					test0.innerHTML = text0.substr(startIndex, splitNum)
					}
					//判断最后一个字符即下一页第一个字符
					endnum=startIndex+splitNum
					if(pattern.test(text0.substr(endnum-1,1)))
					{
						while(1)
						{
							if(pattern.test(text0.substr(endnum-2,1)))
							{
								splitNum=splitNum-1
								endnum=endnum-1
							}
							else 
							{
								break;
							}
						}
					}
					textArray.push(text0.substr(startIndex, splitNum - 1))
					if(patterncontent.test(text0.substr(startIndex, splitNum - 1)))
					{
                       //console.log(pagecontent)
					}
					let lines = textArray[pagecontent-1].split("\n")//split() 方法用于把一个字符串分割成字符串数组。
					lines.forEach(element => {
					if(patterncontent.test(element))
					{
                       //console.log(element)
					   let cobj={pagenum:pagecontent, title:element, sessionNum:0}
					   menuArray.push(cobj)
					}
				    })			
					startIndex += splitNum - 1
					pagecontent+=1			
			 }
			 jumpPage(0)
			 totalPageNum = textArray.length 
			//  document.getElementById('menu-header').innerText = input.files[0].name.split('.')[0]
			document.getElementById('totalPageNum').innerText = totalPageNum  // reader.result为获取结果
			 
			//控制面板赋值
			$('#uploadFileTitle').val(input.files[0].name.split('.')[0])
			$('#statistic-chapters').text(menuArray.length)
			$('#statistic-words').text(text0.length.toLocaleString('en-US'))

			console.log(menuArray,'menuArray')
			getAllObjects()
	   }, false})
	}
	function divfuzhiNLP(i,entityNLP)
	{
		document.getElementById("text").innerText="";
		var lines = textArray[i].split("\n")//split() 方法用于把一个字符串分割成字符串数组。
		var str = ''

		let entityList = []
		let strokeList = []
		let pageEntityListIndex = pageEntityList.findIndex(item=>{
				return item.page === page
		})
		let pageStrokeListIndex = pageStrokeList.findIndex(item=>{
				return item.page === page
		})
		if(pageStrokeListIndex === -1){
			if(curSessionID !== ''){
				session.person.entities.forEach(entity=>{
					if (entity.stroke && entity.pageNum === page) {
						let strokeEntity={
							page:entity.pageNum,
							str:entity.str,
							points:entity.stroke,
							type:'Stroke-PER'
						}
						strokeList.push(strokeEntity)
					}
				})
				if(session.place.stroke.points && session.place.stroke.pageNum === page){
					strokeList.push({
						page:session.place.stroke.pageNum,
						str:session.place.value,
						points:session.place.stroke.points,
						type:'Stroke-LOC'
					})
				}
				if(session.time.stroke.pageNum === page){
					strokeList.push({
						page:session.time.stroke.pageNum,
						str:session.time.value,
						points:session.time.stroke.points,
						type:'Stroke-TIM'
					})
				}
				if(session.event.stroke.pageNum === page){
					strokeList.push({
						page:session.event.stroke.pageNum,
						str:session.event.value,
						points:session.event.stroke.points,
						type:'Stroke-EVT'
					})
				}
			}
			pageStrokeList.push({
				page,
				entityList:strokeList
			})
		}
		 		
		var divId = 0
		var counter = 0
		lines.forEach(element => {
			let entityDictLine = new Array()
			//有片段
			if(curSessionID !== ''){
				//未初始化
				if(pageEntityListIndex === -1){
					var startPage=Infinity , endPage=0
					session.highlight.forEach(eachHighLight=>{
						if(eachHighLight.page>endPage) endPage = eachHighLight.page
						if(eachHighLight.page<startPage) startPage = eachHighLight.page
					})
					if(page >= startPage && page <= endPage){  //TODO 且在片段范围内
						session.person.entities.forEach(entity=>{
							if (!entity.stroke) {
								counter = 0
								while (true) {
									let index = element.indexOf(entity.str,counter)
									if(index !== -1 ){
										entityDictLine.push(
											{
												str:entity.str,
												index:counter+index,
												length:entity.str.length,
												type:'Dict-PER'
											}
										)
										counter += index + entity.str.length
									}else{
										break;
									}
								}
							}
						})
					counter = 0
					while (true) {							
						let index = element.indexOf(session.place.value,counter)
						if(index !== -1 ){
							entityDictLine.push(
								{
									str:session.place.value,
									index:counter+index,
									length:session.place.value.length,
									type:'Dict-LOC'
								}
							)
							counter += index + session.place.value.length
						}else{
							break;
						}	
					}
					}else{	//在片段范围外
						entityDict.forEach(entity => {
						counter = 0
						while (true) {
							let index = element.indexOf(entity,counter)
							if(index !== -1 ){
								entityDictLine.push(
									{
										str:entity,
										index:counter+index,
										length:entity.length,
										type:'Dict-PER'
									}
								)
								counter += index + entity.length
							}else{
								break;
							}
						}	
						});
						if(isNerEnable){
							entityNLP.forEach(entity => {
								if(entity.word.length > 3){
									counter = 0
									while (true) {
										let index = element.indexOf(entity.word,counter)
										if(index !== -1 ){
											entityDictLine.push(
												{
													str:entity.word,
													index:counter+index,
													length:entity.word.length,
													type:`NLP-${entity.entity_group}`
												}
											)
											counter += index + entity.word.length
										}else{
											break;
										}
									}
								}
							});
						}
					}
				}else{	//有片段-已初始化
					let curEntityList = pageEntityList[pageEntityListIndex].entityList
					curEntityList.forEach(entity => {
						counter = 0
						while (true) {						
							let index = element.indexOf(entity.str,counter)
							if(index !== -1 ){
								entityDictLine.push(
									{
										str:entity.str,
										index:counter+index,
										length:entity.str.length,
										type:entity.type
									}
								)
								counter += index + entity.str.length
							}else{
								break;
							}
						}

					});
					//去重
					var obj = {}
					entityDictLine.forEach(item => {
						obj[item.str] = item
					});
					entityDictLine = []
					for (let key in obj) {
						entityDictLine.push(obj[key])
					}
				}

			}else{	//无片段
				if(pageEntityListIndex === -1){	//无片段-未初始化
					entityDict.forEach(entity => {
						counter = 0
						while (true) {					
							let index = element.indexOf(entity,counter)
							if(index !== -1 ){
								entityDictLine.push(
									{
										str:entity,
										index:counter+index,
										length:entity.length,
										type:'Dict-PER'
									}
								)
								counter += index + entity.length
							}else{
								break;
							}
						}
					});
					if(isNerEnable){
						entityNLP.forEach(entity => {
							if(entity.word.length > 3){
								counter = 0
								while (true) {								
									let index = element.indexOf(entity.word,counter)
									if(index !== -1 ){
										entityDictLine.push(
											{
												str:entity.word,
												index:counter+index,
												length:entity.word.length,
												type:`NLP-${entity.entity_group}`
											}
										)
										counter += index + entity.word.length
									}else{
										break;
									}
								}
							}
						});
					}
					//去重
					var obj = {}
					entityDictLine.forEach(item => {
						obj[item.str] = item
					});
					entityDictLine = []
					for (let key in obj) {
						entityDictLine.push(obj[key])
					}
				}else{	//无片段-已初始化
					let curEntityList = pageEntityList[pageEntityListIndex].entityList
					curEntityList.forEach(entity => {
						counter = 0
						while (true) {
							let index = element.indexOf(entity.str,counter)
							if(index !== -1 ){
								entityDictLine.push(
									{
										str:entity.str,
										index:counter+index,
										length:entity.str.length,
										type:entity.type
									}
								)
								counter += index + entity.str.length
							}else{
								break;
							}			
						}
					});
					//去重
					var obj = {}
					entityDictLine.forEach(item => {
						obj[item.str] = item
					});
					entityDictLine = []
					for (let key in obj) {
						entityDictLine.push(obj[key])
					}
				}
			}

			entityDictLine.sort((x,y)=>{
				return x.index - y.index
			})
			//删除元素 后续一直删除
			pageEntityDeleteList.forEach(deleteEntity => {
				for(let i = entityDictLine.length-1;i>=0;i--){
					if(entityDictLine[i].str === deleteEntity.str){
						entityDictLine.splice(i,1)
					}
				}
			})
			//修改元素 后续一直修改
			pageEntityModifyList.forEach(modifyEntity => {
				for(let i = entityDictLine.length-1;i>=0;i--){
					if(entityDictLine[i].str === modifyEntity.str){
						entityDictLine[i].type = modifyEntity.type
					}
				}
			})
			console.log(entityDictLine);
			var p = document.createElement('p')
			
			if(element.length >0){
				let counterI = 0 //entityDictLine 计数器
				for (let i = 0; i < element.length; i++) {
					if(entityDictLine[counterI]){
						let entity = entityDictLine[counterI]
						if(i === entity.index){
							var div = document.createElement('div')
							div.id = guid()
							entityList.push({
								id:div.id,
								str:entity.str,
								type:entity.type,
								page
							})
							while(i< entity.index + entity.length ){
								const char = element[i];
								var e = document.createElement('div')
								e.id = `${page}-${divId++}`
								e.innerHTML = char
								div.appendChild(e)
								i++
							}
							// switch (entity.type) {
							// 	case 'Dict-PER':
							// 		div.classList.add('entity-dict-bg')	
							// 		break;
							// 	case 'Dict-LOC':
							// 		div.classList.add('place-dict-bg')	
							// 		break;
							// 	case 'NLP-PER':
							// 		div.classList.add('entity-nlp-bg')	
							// 		break;
							// 	case 'NLP-LOC':
							// 		div.classList.add('place-nlp-bg')	
							// 		break;
							// 	default:
							// 		break;
							// }

							//click event
							//实体操作
							div.addEventListener('click',function(e){
								console.log(iconStatus);
								curEntityId = this.id
								if(iconStatus.isModify){//TODO
									//弹出面板
									const floatPanelChosen = document.getElementById('float-panel-chosen')
									const chosenText = document.getElementById('chosen-text')
									
									
									let entity = getEntity(this.id)
									var top = entity.top				
									var left = entity.left
									console.log(entity);
	
									floatPanelChosen.style.display = 'block'
									floatPanelChosen.style.top = top+25+'px'
									if(left+250 > document.body.clientWidth){
										floatPanelChosen.style.left = ''
										floatPanelChosen.style.right = '10px'
									}else{
										floatPanelChosen.style.right = ''
										floatPanelChosen.style.left = left+'px'
									}
									chosenText.value = 	entity.str	
									isRecognition = true					
								}else if(iconStatus.isDelete){
									let pageEntity = getPageEntity()
									let curEntity = getEntity(this.id)
									if(curEntity){
										pageEntityDeleteList.push(curEntity) //保存删除元素
										sessionTemplate.splice(
											sessionTemplate.findIndex(item=>{
												return item.str === curEntity.str
										}),1) //保存删除元素

										//相同元素删除
										for(let i = pageEntity.entityList.length-1;i>=0;i--){
											if(pageEntity.entityList[i].str === curEntity.str){
												let index = pageEntity.entityList.findIndex(item=>{
													return item.id === curEntityId
												})
												if(document.getElementById(pageEntity.entityList[i].id).classList.length !== 0){
													$('#'+pageEntity.entityList[i].id).removeClass()
													$('#'+pageEntity.entityList[i].id).addClass('text-bg')		
												}
												console.log();
												pageEntity.entityList.splice(i,1)
											}
										}
										console.log(pageEntity);
										reDrawFragmentView()
										if(curSessionID !== ''){ //isModify 片段修改
											switch (curEntity.type.substr(-3)) {
												case 'PER':
													var personIndex = session.person.entities.findIndex(item=>{
														return item.str === curEntity.str
													})
													session.person.entities.splice(personIndex,1)
													let personList = []
													session.person.entities.forEach(item=>{
														personList.push(item.str)
													})
													session.person.value = personList.join(',')
													curSessionDetail[0].persons = session.person.value

													break;
												case 'LOC':
													session.place.value = curEntity.str
													curSessionDetail[0].place = session.place.value
													break;
											}
											var persons_array = entityDict 
											var page_max = totalPageNum
											drawFragmentView(curSessionDetail,persons_array,page_max)
											pageEntityList = new Array()
                        					pageStrokeList = new Array()
										}
									}
								}
							})
							
							p.appendChild(div)
							counterI++
						}
					}
					const char = element[i];
					var e = document.createElement('div')
						e.id = `${page}-${divId++}`
						e.innerHTML = char
						p.appendChild(e)
						// charIdArray.push(e.id)
				}
				// var e = document.createElement('div')
				// e.innerHTML = "\r"
				document.getElementById('text').appendChild(p)
			}
			
		});
	    pageWords.push({
			page,
			divId
		})
		test0.innerHTML="";
		test0.innerHTML = textArray[page]
		
		console.log(pageWords,'pageWords');
		console.log(textArray[page].length,'textArray[page].length');
		console.log(textArray[page].match(/\n/g));

		//加入每页实体
		entityList.forEach(entity => {
			entity.left = $('#'+entity.id).offset().left
			entity.top = $('#'+entity.id).offset().top
			entity.right = $('#'+entity.id).offset().left+$('#'+entity.id).width()
			entity.bottom = $('#'+entity.id).offset().top+$('#'+entity.id).height()
		});
		
		let index = pageEntityList.findIndex(item=>{
			return item.page === page
		})
		if(index !== -1){
			pageEntityList.splice(index,1)
		}
		pageEntityList.push({
			page,
			entityList
		})
		console.log(pageEntityList);
		console.log(pageStrokeList);

		//highLight 背景
		pageHighLight.forEach(eachHighLight=>{
			if(eachHighLight.page === page){
				for (let i = eachHighLight.startId; i <= eachHighLight.endId; i++) {
					var dom = document.getElementById(`${page}-${i}`)
					dom.classList.add('text-bg')
				}
				
				var pageEntity = pageEntityList.find(item=>{
					return item.page === page
				})
				pageEntity.entityList.forEach(item=>{
					let entityStartIndex = eachHighLight.str.indexOf(item.str)
					if(entityStartIndex !== -1){
						// console.log(`${page}-${startId+entityStartIndex}`,document.getElementById(`${page}-${startId+entityStartIndex}`));
						// console.log(document.getElementById(`${page}-${startId+entityStartIndex}`).parentNode);
						var dom = document.getElementById(`${page}-${eachHighLight.startId+entityStartIndex}`).parentNode
						switch (item.type) {
							case 'Dict-PER':
								dom.classList.add('entity-dict-bg')	
								break;
							case 'Dict-LOC':
								dom.classList.add('place-dict-bg')	
								break;
							case 'NLP-PER':
								dom.classList.add('entity-nlp-bg')	
								break;
							case 'NLP-LOC':
								dom.classList.add('place-nlp-bg')	
								break;
							default:
								break;
						}
						dom.childNodes.forEach(child=>{
							child.classList.remove('text-bg')
						})
					
					}
				})
			}
		})
    }

	function divfuzhi(i)
	{
		document.getElementById("text").innerText="";
		var lines = textArray[i].split("\n")//split() 方法用于把一个字符串分割成字符串数组。
		var str = ''
		lines.forEach(element => {
			var p = document.createElement('p')
			if(element.length >0){
				for(let char of element){
					var e = document.createElement('div')
						e.id = guid()
						e.innerHTML = char
						p.appendChild(e)
					
				}
				// var e = document.createElement('div')
				// e.innerHTML = "\r"
				document.getElementById('text').appendChild(p)
			}
		});
	    test0.innerHTML="";
		test0.innerHTML = textArray[page]
    }

	function onClickOpenMenu() {
		if($('#float-panel-menu').hasClass('float-panel-menu-active')){
			$('#float-panel-menu').removeClass('float-panel-menu-active')
			$('#float-panel-menu').addClass('float-panel-menu-unactive')
		}else{
			$('#float-panel-menu').addClass('float-panel-menu-active')
			$('#float-panel-menu').removeClass('float-panel-menu-unactive')
		}	
	}

	function prepage() 
	{ 
		if(page-1>=0)
	    {
			page=page-1
			jumpPage(page)
		} 
	}	
	function nextpage() 
	{ 
		if( page+1 < textArray.length){			
			page=page+1
			// console.log('page',page);
			jumpPage(page)
		}
	}
	function onPageNumJump() {
		console.log(1);
		var input = document.getElementById('pageNumJump').value-1
		if(input>=0 && input<totalPageNum){		
			page = input
			jumpPage(page)
		}
	}
	function jumpPage(page,strategy='max') {
		
		classification(textArray[page],strategy).then(res=>{
			//去重
			var obj = {}
			res.forEach(item => {
				obj[item.word] = item
			});
			var entityNLP = []
			for (let key in obj) {
				entityNLP.push(obj[key])
			}
			console.log(entityNLP);

			divfuzhiNLP(page,entityNLP)
			_g.clearRect(0, 0, _rc.width, _rc.height);
			drawHighLightByPage()
			drawConnectedPointByPage()
			document.getElementById('curpage').innerText = page+1
			document.getElementById('pageNumJump').value = page+1
	
			//menu update
			var menuItemIndex = findMenuItem(page)
			$('.menu-content').children().each(function(){
				$(this).removeClass('content-item-active')
			});
			$(`.content-item:nth-child(${menuItemIndex})`).addClass('content-item-active')
			
			if((menuItemIndex - 1) <= 3){
				var curTransformY = 0
				$('.menu-content').scrollTop(curTransformY)
				d3.select('#menu-map-g').attr('transform',`translate(60,${curTransformY+15})`)
			}else if((menuItemIndex - 1) > 3 && (menuItemIndex - 1)<menuArray.length-3){
				var curTransformY = (menuItemIndex - 4) * 40
				$('.menu-content').scrollTop(curTransformY)
				d3.select('#menu-map-g').attr('transform',`translate(70,${curTransformY+15})`)
			}
		})
		
		//text summarization
		// if(isTsEnable){
		// 	var summarizationText = textArray[page]
		// 	summarization(summarizationText).then(summarizationRes=>{
		// 		var resStr = ''
		// 		console.log(summarizationRes);
		// 		summarizationRes.forEach(each => {
		// 			resStr += each['summary_text']
		// 		});
		// 		$('#event-container').val(resStr)
		// 	})
		// }
	}
	function findMenuItem(page) {
		for (const menuItemIndex in menuArray) {
			var itemPage = menuArray[menuItemIndex].pagenum
			if(page+1<itemPage) return menuItemIndex
		}
		return menuArray.length
	}

	function getAllObjects() {
		getObjectFromDatabase().then(res=>{
			sessionList = res.data
			//更新数据库
			// sessionList.forEach(session=>{
			// 	var min = Infinity,max = 0;
			// 		for (const key in session) {
			// 			if (Object.hasOwnProperty.call(session, key)) {
			// 				const element = session[key];
			// 				if(element.stroke){
			// 					if(element.stroke.pageNum > max) max = element.stroke.pageNum
			// 					if(element.stroke.pageNum < min) min = element.stroke.pageNum
			// 				}
			// 				// if(key === 'person'){
			// 				// 	var entities = element.value.split(',')
			// 				// 	entities.forEach(entity => {
			// 				// 		if(!entityDict.find(item => item === entity)){
			// 				// 			entityDict.push(entity)
			// 				// 		}
			// 				// 	});
			// 				// }
			// 			}
			// 		}
			// 	session.start = {
			// 		value:min,
			// 		stroke:{
			// 			points:leftStart
			// 		}
			// 	}
			// 	session.end = {
			// 		value:max,
			// 		stroke:{
			// 			points:rightEnd
			// 		}
			// 	}
			// 	console.log(session);
			// 	findByIdAndUpdateObjectIntoDatabase(session).then((status)=>{
			// 		if(status === 200)	console.log('Modify successfully !!!');
			// 	})
			// })
			
			sessionListSL = new Array()
			entityDict = new Array()
			eventCounter = 1
			var pageScaleList = new Array(totalPageNum).fill(0)
			var pageSupportList = new Array(totalPageNum).fill(0)
			sessionList.forEach(each=>{
				var startPage=Infinity , endPage=0
				each.highlight.forEach(eachHighLight=>{
					if(eachHighLight.page>endPage) endPage = eachHighLight.page
					if(eachHighLight.page<startPage) startPage = eachHighLight.page
				})
				if(startPage === endPage){ //同一页
					pageScaleList[startPage]++
				}
			})
			console.log(pageScaleList);
			//数据转换
			for (const eachSession of sessionList) {
				// var min = Infinity,max = 0;
				// for (const key in eachSession) {
				// 	if (Object.hasOwnProperty.call(eachSession, key)) {
				// 		const element = eachSession[key];
				// 		if(element.stroke){
				// 			if(element.stroke.pageNum > max) max = element.stroke.pageNum
				// 			if(element.stroke.pageNum < min) min = element.stroke.pageNum
				// 		}
				// 		// if(key === 'person'){
				// 		// 	var entities = element.value.split(',')
				// 		// 	entities.forEach(entity => {
				// 		// 		if(!entityDict.find(item => item === entity)){
				// 		// 			entityDict.push(entity)
				// 		// 		}
				// 		// 	});
				// 		// }
				// 	}
				// }
				// let l=max-min

				//统计章节交互片段数量
				// menuArray[findMenuItem(min)-1].sessionNum++

				var startPage=Infinity , endPage=0
				eachSession.highlight.forEach(eachHighLight=>{
					if(eachHighLight.page>endPage) endPage = eachHighLight.page
					if(eachHighLight.page<startPage) startPage = eachHighLight.page
				})
				var realStartPage=startPage,realEndPage=endPage

				for (let i = 0; i < startPage; i++) {
					if(pageScaleList[i]!==0){
						realStartPage += 2*pageScaleList[i]-1
					}
				}
				for (let i = 0; i < endPage; i++) {
					if(pageScaleList[i]!==0){
						realEndPage += 2*pageScaleList[i]-1
					}
				}

				if(startPage === endPage){ //同一页
					realStartPage = startPage + pageSupportList[i] * 2
					realEndPage = endPage + pageSupportList[i] * 2 + 1
					pageSupportList[i] ++ 
				}


				sessionListSL.push([`i${eventCounter}`, realStartPage, realEndPage-realStartPage, eachSession.person.value,eachSession.place.value,eachSession.event.value,eachSession.time.value,eachSession._id,eachSession.keywords])
				eventCounter++
			}

			console.log(entityDict,'entityDict');
			console.log(sessionListSL,'sessionListSL');
			console.log(menuArray,'menuArray');		
			//统计面板
			$('#statistic-sessions').text(sessionListSL.length)

			drawMenuMap(menuArray)
			sessionListSL1 = sessionListSL
			drawStoryLine(sessionListSL,menuArray)
			if(curSessionID === ''){
				drawFragmentView()
			}else{
				var persons_array = entityDict 
				var page_max = totalPageNum
				console.log(curSessionDetail);
				drawFragmentView(curSessionDetail,persons_array,page_max)
			}
			changeIcon()
		})	
	}
	//chosen 选中
	function onmouseupElem(dom){
		var id = dom.id
		const floatPanelChosen = document.getElementById('float-panel-chosen')
		floatPanelChosen.style.display = 'none'
		if(isRecognition){ //更改识别实体类型
			var pageEntity =  getPageEntity()
			var entity = getEntity(curEntityId)
			var sessionTemplateEntityIndex = sessionTemplate.findIndex(item=>{
				return item.str === entity.str
			})
			switch (id) {
				case 'chosen-person':
					sessionTemplate[sessionTemplateEntityIndex].type = 'NLP-PER'
					//相同元素修改
					for(let i = pageEntity.entityList.length-1;i>=0;i--){
						if(pageEntity.entityList[i].str === entity.str){
							pageEntity.entityList[i].type = 'NLP-PER'
							if(document.getElementById(pageEntity.entityList[i].id).classList.length !== 0){
								$('#'+pageEntity.entityList[i].id).removeClass()
								$('#'+pageEntity.entityList[i].id).addClass('entity-nlp-bg')	
							}
							console.log();
						}
					}
					break;
				case 'chosen-place':
					sessionTemplate[sessionTemplateEntityIndex].type = 'NLP-LOC'
					//相同元素修改
					for(let i = pageEntity.entityList.length-1;i>=0;i--){
						if(pageEntity.entityList[i].str === entity.str){
							pageEntity.entityList[i].type = 'NLP-LOC'
							if(document.getElementById(pageEntity.entityList[i].id).classList.length !== 0){
								$('#'+pageEntity.entityList[i].id).removeClass()
								$('#'+pageEntity.entityList[i].id).addClass('place-nlp-bg')
							}
							console.log();
						}
					}
					break;
				default:
					break;
			}
			reDrawFragmentView()
			pageEntityModifyList.push(sessionTemplate[sessionTemplateEntityIndex])
			console.log(pageEntityList);
			console.log('pageEntityModifyList',pageEntityModifyList);
		}else{ //新增划线事件
			//赋予划线颜色
			var clr = ''
			//赋予背景样式
			var bg = ''
			var strokeEntity = new Object()
			_textValue= detectReg(_textValue)
			strokeEntity={
				page,
				str:_textValue,
				points:_strokes[0]
			}
			switch (id) {
				case 'chosen-person':		
					strokeEntity.type = 'Stroke-PER'
					clr = "rgb(" + 220 + "," + 96 + "," + 98 + ")";
					bg = 'entity-dict-bg'
					break;
				case 'chosen-time':
					strokeEntity.type = 'Stroke-TIM'
					clr = "rgb(" + 69 + "," + 139 + "," + 197 + ")";
					bg = 'time-dict-bg'
					break;
				case 'chosen-place':
					strokeEntity.type = 'Stroke-LOC'		
					clr = "rgb(" + 184 + "," + 214 + "," + 140 + ")";
					bg = 'place-dict-bg'
					break;
				case 'chosen-event':
					strokeEntity.type = 'Stroke-EVT'
					clr = "rgb(" + 244 + "," + 197 + "," + 21 + ")";
					bg = 'event-dict-bg'
					break;		
				default:
					break;
				}
			_g.strokeStyle = clr;
			// for (let index = 0; index < _strokes[0].length-1; index++) {
			// 	drawConnectedPointByPoints(_strokes[0],index,index+1)
			// }	
			//TODO
			clearStroke(_strokes[0])
			drawConnectedPointByPoints(_strokes[0],0,_strokes[0].length-1)
			var pageStroke = pageStrokeList.find(item=>{
				return item.page === page
			})

			//textdom bg
			var textDoms = [{id:''}]
			var points = _strokes[0]
			//stroke
			for (let index = 0; index < points.length-1; index++) {
				//textdom
				var point = points[index]
				const el = getDomElements(point.X,point.Y-10)
				if(el[1].innerText && el[1].innerText.length===1){
					if(el[1].id !== textDoms[textDoms.length-1].id){
							textDoms[textDoms.length] = el[1]
					}
				}
			}
			textDoms.shift()
			textDoms.forEach(dom=>{
				dom.classList.remove('text-bg')
				dom.classList.add(bg)
			})

			pageStroke.entityList.push(strokeEntity)
			if(curSessionID !== ''){
				let tag = strokeEntity.type.substr(-3)
				switch (tag) {
					case 'PER':
						session.person.entities.push({
							str:strokeEntity.str,
							points:strokeEntity.points,
							pageNum:page
						})
						let personList = []
						session.person.entities.forEach(item=>{
							personList.push(item.str)
						})
						session.person.value = personList.join(',')
						curSessionDetail[0].persons = session.person.value
						break;
					case 'TIM':
						clearTextBg(session.time.stroke.points)
						clearStroke(session.time.stroke.points)
						session.time.value = strokeEntity.str
						session.time.stroke={
							pageNum:page,
							points : strokeEntity.points
						}
						curSessionDetail[0].time = strokeEntity.str
						break;
					case 'LOC':
						clearTextBg(session.place.stroke.points)
						clearStroke(session.place.stroke.points)
						session.place.value = strokeEntity.str
						session.place.stroke={
							pageNum:page,
							points : strokeEntity.points
						}
						curSessionDetail[0].place = strokeEntity.str
						break;
					case 'EVT':
						clearTextBg(session.event.stroke.points)
						clearStroke(session.event.stroke.points)
						session.event.value = strokeEntity.str
						session.event.stroke={
							pageNum:page,
							points : strokeEntity.points
						}
						curSessionDetail[0].event = strokeEntity.str
						break;
					default:
						break;
				}
				var persons_array = entityDict 
				var page_max = totalPageNum
				drawFragmentView(curSessionDetail,persons_array,page_max)
			}else{
				sessionTemplate.push(strokeEntity)
				reDrawFragmentView()
			}
		}
	}

	//chosen界面input事件
	function onkeyupChosenText() {
		const chosenText = document.getElementById('chosen-text')	
		_textValue = chosenText.value
	}
	function onkeyupFragmentText(elemName){
		if(window.event.keyCode === 13){
			document.getElementById(elemName).blur()
		}
		switch (elemName) {
			case 'person':
				session.person.value = document.getElementById(elemName).value
				break;
			case 'time':
				session.time.value = document.getElementById(elemName).value
				break;
			case 'place':
				session.place.value = document.getElementById(elemName).value
				break;
			case 'event':
				session.event.value = document.getElementById(elemName).value
				break;
			default:
				break;
		}
	}

	//configration view
	{
		function onEnableClick(id) {
			switch (id) {
				case 'ner':
					if($('#ner-enable').hasClass('disable')){
						$('#ner-enable').removeClass('disable')
					}else{
						$('#ner-enable').addClass('disable')
					}					
					isNerEnable = !isNerEnable
					if (isImportText) {
						jumpPage(page)
					}
					break;
				case 'ts':
					if($('#ts-enable').hasClass('disable')){
						$('#ts-enable').removeClass('disable')
					}else{
						$('#ts-enable').addClass('disable')
					}	
					isTsEnable = !isTsEnable
					break;
			}
		}

		function onStrategyClick(name) {
			$('.strategy-choices').children().each(function(){
				if(this.id === 'choices-'+name){
					$(this).removeClass('strategy-uncheck')
					$(this).addClass('strategy-check')
				}else{
					$(this).removeClass('strategy-check')
					$(this).addClass('strategy-uncheck')
				}
			})
			if (isImportText) {	
				jumpPage(page,name)
			}
		}

		function onDragEnd(e) {
			console.log(e);
		}
	}
	//Text View 事件
	function onClickStatus(statusName) {
		switch (statusName) {
			case 'highlight':
				iconStatus.isHighLight = true
				
				// drawFragmentView()
				// curSessionID = ''
				// session = new Session()
				// var curPageEntityList = getPageEntity()
				// var curPageStrokeList = getPageStroke()

				// pageEntityList = new Array()
				// pageStrokeList = new Array()
				// pageEntityList.push(curPageEntityList)
				// pageStrokeList.push(curPageStrokeList)
				
				break;
			case 'select':
				iconStatus.isHighLight = false
				break;
			case 'modify':
				iconStatus.isModify = true
				iconStatus.isDelete = false
				break;
			case 'delete':
				iconStatus.isModify = false
				iconStatus.isDelete = true
				break;
			default:
				break;
		}
	console.log(iconStatus);
	changeIcon()
	}
	function changeIcon(){
		if(iconStatus.isHighLight){
			$("#highlight").attr('src','/img/Highlight-chosen.png')
			$("#select").attr('src','/img/select.png')
			$('#myCanvas').attr('style','pointer-events:none')
		}else{
			$("#highlight").attr('src','/img/Highlight.png')
			$("#select").attr('src','/img/select-chosen.png')
			$('#myCanvas').attr('style','pointer-events:auto')
		}
		if(iconStatus.isModify){
			$("#modify").attr('src','/img/modify-chosen.png')
		}else{
			$("#modify").attr('src','/img/modify.png')
		}
		if(iconStatus.isDelete){
			$("#delete").attr('src','/img/delete-chosen.png')
		}else{
			$("#delete").attr('src','/img/delete.png')
		}
	}
	</script>
</head>
<body onload="onLoadEvent()">
	<div class="outer-wrapper">
		<div class="panel-wrapper flex-panel-wrapper inner-wrapper">
			<div class="panel h-left-panel">
				<div class="panel-wrapper">
					<div class="panel v-panel panel-left-top">
						<div class="view">
							<div id="menu-view" class="view-content over-view-content">
								<div class="nav">
									<div class="nav-tool-container">
										<span class="header-icon"><img class="svg-icon" src="/img/header-icon.png"></span>
										<span class="title">System Overview</span>
									</div>
								</div>
								<div class="over-view-container">
									<div class="input-group input-group-sm input-file">
										<span class="input-group-text">Upload</span>
										<input id="uploadFileTitle" type="text" class="form-control upload-file">
										<span class="tool-btn" title="Open File"><span class="open-icon" onclick="onClickImportText()"></span></span>	
									</div>
									<div class="statistics-panel-wrapper">
										<div class="statistic-panel">
											<div id="statistic-chapters" class="statistic-num">0</div>
											<div class="statistic-title">Chapters</div>
										</div>
										<div class="statistic-panel">
											<div id="statistic-words" class="statistic-num">0</div>
											<div class="statistic-title">Total words</div>
										</div>
										<div class="statistic-panel">
											<div id="statistic-sessions" class="statistic-num">0</div>
											<div class="statistic-title">Sessions</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="panel v-panel panel-left-center">
						<div class="view">
							<div id="menu-view" class="view-content configuration-view-content">
								<div class="nav">
									<div class="nav-tool-container">
										<span class="header-icon"><img class="svg-icon" src="/img/header-icon.png"></span>
										<span class="title">Configuration View</span>
									</div>
								</div>
								<div class="configuration-view-container">
									<div class="ner-container">
										<div class="title">
											<div>Named Entity</div>
											<div class="title-bottom">Recognition</div>
										</div>
										<div class="title-enable">Enable</div>
										<span class="tool-btn choose-box"><img class="svg-icon" src="/img/single-choice.png"></span>
										<span class="tool-btn choose-box-confirm" id="ner-enable" onclick="onEnableClick('ner')"><img class="svg-icon" src="/img/gou.png"></span>
										
										<div class="title-strategy">Strategy:</div>
										<div class="strategy-choices">
											<div id="choices-first" class="strategy-check" onclick="onStrategyClick('first')">first</div>
											<div id="choices-max" class="strategy-uncheck" onclick="onStrategyClick('max')">max</div>
											<div id="choices-none" class="strategy-uncheck" onclick="onStrategyClick('none')">none</div>
											<div id="choices-simple" class="strategy-uncheck" onclick="onStrategyClick('simple')">simple</div>
											<div id="choices-average" class="strategy-uncheck" onclick="onStrategyClick('average')">average</div>
										</div>
									</div>
									<div class="ts-container">
										<div class="title">
											<div>Text</div>
											<div>Summarization</div>
										</div>

										<div class="title-enable">Enable</div>
										<span class="tool-btn choose-box"><img class="svg-icon" src="/img/single-choice.png"></span>
										<span class="tool-btn choose-box-confirm" id="ts-enable" onclick="onEnableClick('ts')"><img class="svg-icon" src="/img/gou.png"></span>
										
										<div class="title-length">Length</div>
										<div class="slider">
											<input type="hidden" id="length-slider" value="40,80"/>
										</div>

										<div class="title-numbeams">Num Beams</div>
										<div class="numbeams-content">
											<input type="text" value="3" id="num-beams" class="numbeams-text">
											<div class="numbeams-confirm">
												<span class="tool-btn numbeams-confirm-icon"><img class="svg-icon" src="/img/gou2.png"></span>
											</div>
										</div>
									</div>
								</div>

							</div>
						</div>
					</div>
					<div class="panel v-panel panel-left-bottom">
						<div class="view">
							<div id="fragment-view" class="view-content fragment-view-content">
								<div class="nav">
									<div class="nav-tool-container">
										<span class="header-icon"><img class="svg-icon" src="/img/header-icon.png"></span>
										<span class="title">Fragment View</span>
									</div>
								</div>
								<div id="panel-fragment" class="panel-fragment">
					
									<div class="fragments-wrapper">
										<input id="time_input" type="text">
										<input id="place_input" type="text">
										<textarea id="event_input" rows="5" cols="30"></textarea>
										<img src="/img/event2.png" id="event_img">

										<div id="operation_panel">
										</div>
										<img src="/img/click.png" id="click_img">
										<img src="/img/bj.png" id="bj_img">
										<img src="/img/ok.png" id="ok_img">
							
									</div>
								</div>
								
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="panel h-center-panel">
				<div class="panel-wrapper">
					<div class="panel v-panel panel-center-top" id="panel-center-top" >
						<div class="view">
						
							<div id="text-view" class="view-content text-view-content">
								<div class="nav">
									<div class="nav-tool-container">
										<span class="header-icon"><img class="svg-icon" src="/img/header-icon.png"></span>
										<span class="title">Text View</span>
									</div>
									<div class="nav-tool-container-right">
										<div class="page-container">
											<span class="tool-btn-long" title="HighLight" onclick="onClickStatus('highlight')"><img id="highlight" class="svg-icon" src="/img/Highlight-chosen.png"></span>
											<span class="tool-separator"></span>
											<span class="tool-btn-long" title="Select" onclick="onClickStatus('select')"><img id="select" class="svg-icon" src="/img/select.png"></span>
											<span class="tool-separator"></span>
											<span class="tool-btn-long" title="Modify" onclick="onClickStatus('modify')"><img id="modify" class="svg-icon" src="/img/modify.png"></span>
											<span class="tool-separator"></span>
											<span class="tool-btn-long" title="Delete"  onclick="onClickStatus('delete')"><img id="delete" class="svg-icon" src="/img/delete.png"></span>
											<span class="tool-separator"></span>
											<span class="tool-btn" title="Share" style="height: 18px;width: 18px;margin-top: 1px;"><img class="svg-icon" src="/img/share.png"></span>
											<span class="tool-btn" title="Print" style="height: 18px;width: 18px;margin-top: 1px;"><img class="svg-icon" src="/img/print.png"></span>
											<span class="tool-separator"></span>
											<span class="tool-btn" title="Zoom" style="height: 18px;width: 18px;margin-top: 1px;"><img class="svg-icon" src="/img/zoom.png"></span>
											<span class="tool-btn" title="Menu" onclick="onClickOpenMenu()" ><img class="svg-icon" style="filter: invert(60%);" src="/img/menu.png"></span>
											<span class="tool-separator"></span>
											<span class="tool-btn" title="AddFragment" id="addFragment" onclick="onClickAddFragment()"><img class="svg-icon" style="filter: invert(60%);" src="/img/add.png"></span>
											<span class="tool-btn" title="Clear" id="clear" onclick="onClickClearStrokes()"><img class="svg-icon" style="filter: invert(60%);" src="/img/clear.png"></span>
										</div>
									</div>
								</div>	
								<div id="text"></div>
								<div id="test0"></div>
						
								<canvas id="myCanvas" width="1000" height="400"
								onmousedown="mouseDownEvent(event.clientX, event.clientY, event.button)"
								onmousemove="mouseMoveEvent(event.clientX, event.clientY, event.button)"
								onmouseup="mouseUpEvent(event.clientX, event.clientY, event.button)"
								oncontextmenu="return false;">
									<span style="background-color:#ffff88;">The &lt;canvas&gt; element is not supported by this browser.</span>
								</canvas>
								<div class="pagination">
									<div class="pagination-left">
										<span class="tool-text-other" >Total </span>
										<span class="tool-text-totalpage" id="totalPageNum">100</span>
									</div>
									<div class="pagination-right">
										<span class="tool-btn" title="prepage" id="prepage" onclick="prepage()"><img class="svg-icon" src="/img/arrow-new-left.png"></span>
										<span class="tool-text-main" id="curpage">1</span>
										<span class="tool-btn" title="nextpage" id="nextpage" onclick="nextpage()"><img class="svg-icon" src="/img/arrow-new-right.png"></span>
										
										<input class="tool-text-input" type="text" id="pageNumJump" value="1">
										<span class="tool-text-go" onclick="onPageNumJump()">Go</span>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="panel v-panel panel-center-bottom" id="panel-center-bottom" >
						<div class="view">
							<div class="view-content storyline-view-content">
								<div class="nav">
									<div class="nav-tool-container">
										<span class="header-icon"><img class="svg-icon" src="/img/header-icon.png"></span>
										<span class="title">Storyline</span>
									</div>
								</div>
								<div id="storyline-view">

								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div id="float-panel-menu" class="float-panel-menu">
		<div class="menu-wrapper">
			<div class="menu-header">Contents</div>
			<div class="menu-content">
				<!-- <div class="content-item active">
					<span class="item-title">第21回 女儿国唐三藏奇遇</span>
					<span class="item-page">01</span>
				</div> -->
			</div>
		</div>

	</div>
	<div id="float-panel-chosen" class="float-panel-chosen">
		<div class="text-wrapper">
			<!-- <div id="chosen-text" class="text"></div> -->
			<input type="text" id="chosen-text" class="text" onkeyup="onkeyupChosenText()">
		</div>
		<div class="elems-wrapper">
			<div id="chosen-person" class="elem-wrapper border-person" onmouseup="onmouseupElem(this)">
				<span class="elem-img"><img class="svg-icon" src="/img/person.png"></span>
				<div class="elem-text text-person">Person</div>
			</div>
			<div id="chosen-time" class="elem-wrapper border-time" onmouseup="onmouseupElem(this)">
				<span class="elem-img"><img class="svg-icon" src="/img/time.png"></span>
				<div class="elem-text text-time">Time</div>
			</div>
			<div id="chosen-place" class="elem-wrapper border-place" onmouseup="onmouseupElem(this)">
				<span class="elem-img"><img class="svg-icon" src="/img/place.png"></span>
				<div class="elem-text text-place">Place</div>
			</div>
			<div id="chosen-event" class="elem-wrapper border-event" onmouseup="onmouseupElem(this)">
				<span class="elem-img"><img class="svg-icon" src="/img/event.png"></span>
				<div class="elem-text text-event">Event</div>
			</div>
		</div>
	</div>
	<defs>
        <!-- 添加带箭头的标线 -->
        <marker
          id="markerArrow"
          markerWidth="8"
          markerHeight="8"
          refx="2"
          refy="5"
          orient="auto"
        >
          <path d="M2,2 L2,8 L8,5 L2,2" style="fill: #61a8e0" />  
        </marker>
    </defs>
</body>
<script type="text/javascript">
	// dragFuncIndex('float-panel-fragment','fragments-top')
	$(document).ready(function(){
		  $('#length-slider').jRange({
			  from: 20,
			  to: 100,
			  step: 1, 
			  format: '%s',
			  width: 135,
			  showLabels: true,
			  showScale: true,
			  isRange : true,
			  ondragend:(e)=>onDragEnd(e)
		  });
	  });
	drawFragmentView()
	changeIcon()
	
	$('#text').mouseup(function() {
		getSelectedText();
	});

	function getSelectedText() {
		console.log(window.getSelection().anchorNode.parentNode.id);
		console.log(window.getSelection().extentNode.parentNode.id);
		var startId = parseInt(window.getSelection().anchorNode.parentNode.id.split('-')[1])
		var endId = parseInt(window.getSelection().extentNode.parentNode.id.split('-')[1])

		if(startId > endId){
			let temp = endId
			endId = startId
			startId = temp
		}
		if(endId-startId >= 3){ //解决修改时选中单个字母背景变色问题
			for (let i = startId; i <= endId; i++) {
				var dom = document.getElementById(`${page}-${i}`)
				dom.classList.add('text-bg')
			}
		}
		
		var pageEntity = pageEntityList.find(item=>{
			return item.page === page
		})
		pageEntity.entityList.forEach(item=>{
			let entityStartIndex = window.getSelection().toString().indexOf(item.str)
			if(entityStartIndex !== -1){
				sessionTemplate.push(item)
				// console.log(`${page}-${startId+entityStartIndex}`,document.getElementById(`${page}-${startId+entityStartIndex}`));
				// console.log(document.getElementById(`${page}-${startId+entityStartIndex}`).parentNode);
				var dom = document.getElementById(`${page}-${startId+entityStartIndex}`).parentNode
				if(dom.tagName !== 'P'){
					switch (item.type) {
						case 'Dict-PER':
							dom.classList.add('entity-dict-bg')	
							break;
						case 'Dict-LOC':
							dom.classList.add('place-dict-bg')	
							break;
						case 'NLP-PER':
							dom.classList.add('entity-nlp-bg')	
							break;
						case 'NLP-LOC':
							dom.classList.add('place-nlp-bg')	
							break;
						default:
							break;
					}
					dom.childNodes.forEach(child=>{
						child.classList.remove('text-bg')
					})
				}
			
			}
		})
		if(endId-startId >= 3){
			pageHighLight.push({
				page,
				startId,
				endId,
				str:window.getSelection().toString()
			})
		}
		console.log(pageHighLight);

		//词频统计
		var wordFrequency = new Array()
		var originText,highLightText,strokeText
		var startPage=Infinity , endPage=0
		pageHighLight.forEach(eachHighLight=>{
			if(eachHighLight.page>endPage) endPage = eachHighLight.page
			if(eachHighLight.page<startPage) startPage = eachHighLight.page
			highLightText += eachHighLight.str
		})
		for(var pageIndex = startPage;pageIndex<=endPage;pageIndex++){
			originText += textArray[pageIndex]
		}
		strokeText = session.event.value
		originText = originText.split(' ')
		highLightText = highLightText.split(' ')
		strokeText = strokeText.split(' ')
		originText.forEach(itemText=>{
			var wfIndex = wordFrequency.findIndex(itemWF=>{
				return itemWF.name === itemText
			})
			if( wfIndex === -1){
				wordFrequency.push({
                    "name": itemText,
                    "value": 1,
                    "color":"rgba(0, 0, 0)"
				})
			}else{
				wordFrequency[wfIndex].value++
			}
		})
		highLightText.forEach(itemText=>{
			var wfIndex = wordFrequency.findIndex(itemWF=>{
				return itemWF.name === itemText
			})
			if( wfIndex === -1){
				wordFrequency.push({
                    "name": itemText,
                    "value": 5,
                    "color":"rgba(0, 0, 0)"
				})
			}else{
				wordFrequency[wfIndex].value += 5
			}
		})
		strokeText.forEach(itemText=>{
			var wfIndex = wordFrequency.findIndex(itemWF=>{
				return itemWF.name === itemText
			})
			if( wfIndex === -1){
				wordFrequency.push({
                    "name": itemText,
                    "value": 15,
                    "color":"rgba(0, 0, 0)"
				})
			}else{
				wordFrequency[wfIndex].value += 15
			}
		})
		wordFrequency = wordFrequency.filter(item=>{
			return item.value >= 5 && item.name.length > 3
		})
		console.log('wf',wordFrequency);


		//text summarization
		var isEVT = sessionTemplate.findIndex(item=>{
			return item.type.substr(-3) === 'EVT'
		})
		var summarizationText = ''
		pageHighLight.forEach(eachHighLight=>{
			summarizationText += eachHighLight.str
		})
		if(isTsEnable && isEVT === -1){
			summarization(summarizationText).then(summarizationRes=>{
				var resStr = ''
				console.log(summarizationRes);
				summarizationRes.forEach(each => {
					resStr += each['summary_text']
				});
				sessionTemplate.push({
					page,
					points:[],
					str:resStr,
					type:"TS-EVT"
				})
				reDrawFragmentView()
			})
		}else{
			reDrawFragmentView()
		}


		window.getSelection().empty()
	}
</script>
</html>